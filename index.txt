<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClassChat</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & Babel & Modules -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js",
        "lucide-react": "https://esm.sh/lucide-react@0.294.0"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <!-- Application Code -->
    <script type="text/babel" data-type="module" data-presets="react,typescript">
        import React, { useState, useEffect, useRef, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged
        } from 'firebase/auth';
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            onSnapshot, 
            query, 
            where,
            serverTimestamp,
            doc,
            setDoc
        } from 'firebase/firestore';
        import { 
            MessageCircle, 
            Users, 
            Send, 
            LogOut, 
            Copy, 
            Check, 
            User, 
            School,
            ArrowRight,
            AlertTriangle
        } from 'lucide-react';

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyC9vqXA2mLhqx2jHH4v53Jc2Jvp6rswI2s",
            authDomain: "classchat-6c29f.firebaseapp.com",
            projectId: "classchat-6c29f",
            storageBucket: "classchat-6c29f.firebasestorage.app",
            messagingSenderId: "410404733532",
            appId: "1:410404733532:web:f3076db4ef953fd8c15c99",
            measurementId: "G-S2JYFQD7E0"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Components ---
        function App() {
            const [user, setUser] = useState(null);
            const [mode, setMode] = useState('landing');
            const [roomId, setRoomId] = useState('');
            const [studentName, setStudentName] = useState('');
            
            const [messages, setMessages] = useState([]);
            const [participants, setParticipants] = useState([]);
            const [loading, setLoading] = useState(true);
            const [authError, setAuthError] = useState(null);

            useEffect(() => {
                const initAuth = async () => {
                    try {
                        await signInAnonymously(auth);
                    } catch (err) {
                        console.error("Auth Error:", err);
                        setAuthError(err.message);
                        setLoading(false);
                    }
                };
                initAuth();
                
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const roomParam = params.get('room');
                if (roomParam) {
                    setRoomId(roomParam);
                }
            }, []);

            useEffect(() => {
                if (!user || !roomId || mode === 'landing') return;

                const participantsRef = collection(db, 'classroom_participants');
                const qParticipants = query(participantsRef, where('roomId', '==', roomId));
                
                const unsubParticipants = onSnapshot(qParticipants, (snapshot) => {
                    const parts = [];
                    snapshot.forEach(doc => {
                        parts.push({ id: doc.id, ...doc.data() });
                    });
                    setParticipants(parts);
                }, (error) => console.error("Participants error:", error));

                const messagesRef = collection(db, 'classroom_messages');
                const qMessages = query(messagesRef, where('roomId', '==', roomId));

                const unsubMessages = onSnapshot(qMessages, (snapshot) => {
                    const msgs = [];
                    snapshot.forEach(doc => {
                        msgs.push({ id: doc.id, ...doc.data() });
                    });
                    msgs.sort((a, b) => {
                        const tA = a.timestamp?.toMillis() || Date.now();
                        const tB = b.timestamp?.toMillis() || Date.now();
                        return tA - tB;
                    });
                    setMessages(msgs);
                }, (error) => console.error("Messages error:", error));

                return () => {
                    unsubParticipants();
                    unsubMessages();
                };
            }, [user, roomId, mode]);

            const createRoom = async () => {
                if (!user) return;
                const newRoomId = Math.random().toString(36).substring(2, 8).toUpperCase();
                setRoomId(newRoomId);
                setMode('teacher');
                
                await setDoc(doc(db, 'classroom_rooms', newRoomId), {
                    createdAt: serverTimestamp(),
                    teacherId: user.uid
                });
            };

            const joinRoom = async () => {
                if (!user || !roomId || !studentName.trim()) return;
                
                await setDoc(doc(db, 'classroom_participants', user.uid), {
                    roomId: roomId,
                    name: studentName,
                    joinedAt: serverTimestamp()
                });

                setMode('student');
            };

            const sendMessage = async (text, targetStudentId, targetStudentName, senderType) => {
                if (!text.trim()) return;

                await addDoc(collection(db, 'classroom_messages'), {
                    roomId,
                    studentId: targetStudentId,
                    studentName: targetStudentName,
                    text: text,
                    senderType,
                    timestamp: serverTimestamp()
                });
            };

            if (loading) return <div className="flex h-screen items-center justify-center bg-gray-50 text-gray-500">読み込み中...</div>;

            if (authError) {
                return (
                    <div className="flex h-screen items-center justify-center bg-red-50 p-4">
                        <div className="bg-white p-6 rounded-lg shadow-md max-w-sm text-center">
                            <div className="flex justify-center mb-4">
                                <AlertTriangle className="w-10 h-10 text-red-500" />
                            </div>
                            <h3 className="text-red-500 font-bold mb-2">認証エラー</h3>
                            <p className="text-gray-600 text-sm mb-4">
                                Firebaseへの接続に失敗しました。<br/>
                                設定やネットワーク接続を確認してください。
                            </p>
                            <div className="bg-gray-100 p-2 rounded text-xs text-left overflow-auto mb-4 font-mono max-h-20">
                                {authError}
                            </div>
                            <button onClick={() => window.location.reload()} className="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300 text-sm transition-colors">
                                再読み込み
                            </button>
                        </div>
                    </div>
                )
            }

            return (
                <div className="min-h-screen bg-gray-100 font-sans text-gray-800">
                    <header className="bg-white shadow-sm sticky top-0 z-10">
                        <div className="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-2">
                                <School className="text-indigo-600 w-6 h-6" />
                                <h1 className="font-bold text-lg md:text-xl text-gray-800">
                                    ClassChat <span className="text-xs font-normal text-gray-500 bg-gray-100 px-2 py-1 rounded-full ml-2">Beta</span>
                                </h1>
                            </div>
                            
                            {mode !== 'landing' && (
                                <div className="flex items-center gap-4">
                                    <div className="flex items-center gap-2 bg-indigo-50 px-3 py-1 rounded-lg">
                                        <span className="text-xs text-indigo-500 uppercase font-bold">Room ID</span>
                                        <span className="font-mono font-bold text-indigo-700 text-lg">{roomId}</span>
                                    </div>
                                    <button 
                                        onClick={() => {
                                            setMode('landing');
                                            setRoomId('');
                                            setMessages([]);
                                            setParticipants([]);
                                            window.history.pushState({}, '', window.location.pathname);
                                        }}
                                        className="text-gray-500 hover:text-red-500 transition-colors"
                                        title="退出"
                                    >
                                        <LogOut className="w-5 h-5" />
                                    </button>
                                </div>
                            )}
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto p-4">
                        {mode === 'landing' && (
                            <LandingView 
                                roomId={roomId} 
                                setRoomId={setRoomId} 
                                studentName={studentName}
                                setStudentName={setStudentName}
                                onCreateRoom={createRoom} 
                                onJoinRoom={joinRoom} 
                            />
                        )}
                        
                        {mode === 'teacher' && (
                            <TeacherDashboard 
                                roomId={roomId}
                                participants={participants}
                                messages={messages}
                                onSendMessage={sendMessage}
                            />
                        )}

                        {mode === 'student' && user && (
                            <StudentDashboard 
                                currentUserId={user.uid}
                                messages={messages}
                                onSendMessage={(text) => sendMessage(text, user.uid, studentName, 'student')}
                            />
                        )}
                    </main>
                </div>
            );
        }

        // --- Sub Components ---
        function LandingView({ roomId, setRoomId, studentName, setStudentName, onCreateRoom, onJoinRoom }) {
            const [activeTab, setActiveTab] = useState('student');

            return (
                <div className="flex flex-col items-center justify-center pt-10 px-4">
                    <div className="w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden">
                        <div className="flex border-b border-gray-100">
                            <button 
                                onClick={() => setActiveTab('student')}
                                className={`flex-1 py-4 text-sm font-semibold flex items-center justify-center gap-2 transition-colors ${activeTab === 'student' ? 'bg-indigo-50 text-indigo-600 border-b-2 border-indigo-600' : 'text-gray-500 hover:bg-gray-50'}`}
                            >
                                <User className="w-4 h-4" /> 生徒として参加
                            </button>
                            <button 
                                onClick={() => setActiveTab('teacher')}
                                className={`flex-1 py-4 text-sm font-semibold flex items-center justify-center gap-2 transition-colors ${activeTab === 'teacher' ? 'bg-indigo-50 text-indigo-600 border-b-2 border-indigo-600' : 'text-gray-500 hover:bg-gray-50'}`}
                            >
                                <School className="w-4 h-4" /> 教師として開始
                            </button>
                        </div>

                        <div className="p-8">
                            {activeTab === 'student' ? (
                                <div className="space-y-4">
                                    <div className="text-center mb-6">
                                        <h2 className="text-2xl font-bold text-gray-800">授業に参加する</h2>
                                        <p className="text-gray-500 text-sm mt-1">先生から共有された部屋IDを入力してください</p>
                                    </div>
                                    
                                    <div>
                                        <label className="block text-xs font-bold text-gray-500 uppercase mb-1">部屋 ID</label>
                                        <input 
                                            type="text" 
                                            value={roomId}
                                            onChange={(e) => setRoomId(e.target.value.toUpperCase())}
                                            placeholder="例: X7Y2Z9"
                                            className="w-full bg-gray-50 border border-gray-200 rounded-lg px-4 py-3 font-mono text-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all uppercase"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-xs font-bold text-gray-500 uppercase mb-1">お名前</label>
                                        <input 
                                            type="text" 
                                            value={studentName}
                                            onChange={(e) => setStudentName(e.target.value)}
                                            placeholder="出席簿の名前を入力"
                                            className="w-full bg-gray-50 border border-gray-200 rounded-lg px-4 py-3 text-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all"
                                        />
                                    </div>

                                    <button 
                                        onClick={onJoinRoom}
                                        disabled={!roomId || !studentName}
                                        className="w-full bg-indigo-600 hover:bg-indigo-700 disabled:bg-gray-300 disabled:cursor-not-allowed text-white font-bold py-3 rounded-lg shadow-md transition-all flex items-center justify-center gap-2 mt-2"
                                    >
                                        入室する <ArrowRight className="w-5 h-5" />
                                    </button>
                                </div>
                            ) : (
                                <div className="space-y-6 text-center">
                                    <div className="mb-4">
                                        <h2 className="text-2xl font-bold text-gray-800">新しい授業ルーム</h2>
                                        <p className="text-gray-500 text-sm mt-1">生徒からの質問をリアルタイムで受け付けます</p>
                                    </div>
                                    <div className="bg-indigo-50 rounded-xl p-6 flex flex-col items-center">
                                        <MessageCircle className="w-12 h-12 text-indigo-400 mb-2" />
                                        <p className="text-indigo-900 font-medium">個別のスレッド形式で<br/>全員の質問を管理できます</p>
                                    </div>
                                    <button 
                                        onClick={onCreateRoom}
                                        className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg shadow-md transition-all flex items-center justify-center gap-2"
                                    >
                                        部屋を作成して開始 <ArrowRight className="w-5 h-5" />
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        function TeacherDashboard({ roomId, participants, messages, onSendMessage }) {
            const [copied, setCopied] = useState(false);

            const studentThreads = useMemo(() => {
                const threads = {};
                participants.forEach(p => {
                    threads[p.id] = [];
                });
                messages.forEach(m => {
                    if (!threads[m.studentId]) threads[m.studentId] = [];
                    threads[m.studentId].push(m);
                });
                return threads;
            }, [participants, messages]);

            const copyLink = () => {
                const url = `${window.location.origin}${window.location.pathname}?room=${roomId}`;
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(url)
                        .then(() => {
                            setCopied(true);
                            setTimeout(() => setCopied(false), 2000);
                        })
                        .catch(() => {
                            alert("URL: " + url);
                        });
                } else {
                    prompt("以下のURLをコピーしてください:", url);
                }
            };

            return (
                <div className="space-y-6">
                    <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col md:flex-row items-center justify-between gap-4">
                        <div className="flex items-center gap-2">
                            <Users className="text-gray-400 w-5 h-5" />
                            <span className="font-medium text-gray-700">参加人数: <span className="font-bold text-indigo-600">{participants.length}</span>名</span>
                        </div>
                        <button 
                            onClick={copyLink}
                            className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-all ${copied ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}
                        >
                            {copied ? <Check className="w-4 h-4" /> : <Copy className="w-4 h-4" />}
                            {copied ? 'リンクをコピーしました' : '招待リンクをコピー'}
                        </button>
                    </div>

                    {participants.length === 0 ? (
                        <div className="text-center py-20 bg-white rounded-xl border border-dashed border-gray-300">
                            <div className="text-gray-400 mb-2">まだ生徒がいません</div>
                            <div className="text-sm text-gray-500">招待リンクを共有して生徒を招待しましょう</div>
                        </div>
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                            {Object.entries(studentThreads).map(([studentId, msgs]) => {
                                const student = participants.find(p => p.id === studentId);
                                return (
                                    <ChatCard 
                                        key={studentId}
                                        studentId={studentId}
                                        studentName={student?.name || '不明な生徒'}
                                        messages={msgs}
                                        onSendMessage={onSendMessage}
                                    />
                                );
                            })}
                        </div>
                    )}
                </div>
            );
        }

        function ChatCard({ studentId, studentName, messages, onSendMessage }) {
            const [input, setInput] = useState('');
            const scrollRef = useRef(null);

            useEffect(() => {
                if (scrollRef.current) {
                    scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
                }
            }, [messages]);

            const handleSend = (e) => {
                e.preventDefault();
                if (!input.trim()) return;
                onSendMessage(input, studentId, studentName, 'teacher');
                setInput('');
            };

            const lastMessage = messages[messages.length - 1];
            const hasUnread = lastMessage && lastMessage.senderType === 'student'; 

            return (
                <div className={`bg-white rounded-xl shadow-sm border flex flex-col h-[350px] overflow-hidden transition-all ${hasUnread ? 'border-indigo-300 ring-2 ring-indigo-100' : 'border-gray-200'}`}>
                    <div className="bg-gray-50 px-4 py-3 border-b border-gray-100 flex items-center justify-between">
                        <div className="flex items-center gap-2 overflow-hidden">
                            <div className="w-2 h-2 rounded-full bg-green-400 flex-shrink-0"></div>
                            <h3 className="font-bold text-gray-700 truncate text-sm" title={studentName}>{studentName}</h3>
                        </div>
                        {hasUnread && <div className="w-2 h-2 bg-indigo-500 rounded-full animate-pulse"></div>}
                    </div>

                    <div ref={scrollRef} className="flex-1 overflow-y-auto p-3 space-y-3 bg-white scrollbar-thin scrollbar-thumb-gray-200">
                        {messages.length === 0 && (
                            <div className="text-center text-xs text-gray-300 mt-10">メッセージはまだありません</div>
                        )}
                        {messages.map((msg) => {
                            const isTeacher = msg.senderType === 'teacher';
                            return (
                                <div key={msg.id} className={`flex ${isTeacher ? 'justify-end' : 'justify-start'}`}>
                                    <div 
                                        className={`max-w-[85%] rounded-2xl px-3 py-2 text-xs leading-relaxed break-words ${
                                            isTeacher 
                                                ? 'bg-indigo-600 text-white rounded-br-none' 
                                                : 'bg-gray-100 text-gray-800 rounded-bl-none'
                                        }`}
                                    >
                                        {msg.text}
                                    </div>
                                </div>
                            );
                        })}
                    </div>

                    <form onSubmit={handleSend} className="p-2 border-t border-gray-100 bg-gray-50">
                        <div className="flex items-center gap-2">
                            <input
                                type="text"
                                value={input}
                                onChange={(e) => setInput(e.target.value)}
                                placeholder="返信する..."
                                className="flex-1 bg-white border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-indigo-400 transition-colors"
                            />
                            <button 
                                type="submit" 
                                disabled={!input.trim()}
                                className="p-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:hover:bg-indigo-600 transition-colors"
                            >
                                <Send className="w-4 h-4" />
                            </button>
                        </div>
                    </form>
                </div>
            );
        }

        function StudentDashboard({ currentUserId, messages, onSendMessage }) {
            const [input, setInput] = useState('');
            const scrollRef = useRef(null);

            const myMessages = messages.filter(m => m.studentId === currentUserId);

            useEffect(() => {
                if (scrollRef.current) {
                    scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
                }
            }, [myMessages]);

            const handleSend = (e) => {
                e.preventDefault();
                if (!input.trim()) return;
                onSendMessage(input);
                setInput('');
            };

            return (
                <div className="max-w-2xl mx-auto h-[calc(100vh-120px)] flex flex-col bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-200">
                    <div className="bg-indigo-50 px-6 py-4 border-b border-indigo-100">
                        <p className="text-sm text-indigo-800 text-center font-medium">
                            先生に質問や意見を送ることができます。<br/>
                            <span className="text-xs opacity-70">他の生徒にはあなたのメッセージは見えません。</span>
                        </p>
                    </div>

                    <div ref={scrollRef} className="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50">
                        {myMessages.length === 0 && (
                            <div className="flex flex-col items-center justify-center h-full text-gray-400 space-y-2 opacity-60">
                                <MessageCircle className="w-12 h-12" />
                                <p className="text-sm">気軽に投稿してみましょう</p>
                            </div>
                        )}
                        
                        {myMessages.map((msg) => {
                            const isMe = msg.senderType === 'student';
                            return (
                                <div key={msg.id} className={`flex ${isMe ? 'justify-end' : 'justify-start'}`}>
                                    <div className={`flex flex-col ${isMe ? 'items-end' : 'items-start'} max-w-[80%]`}>
                                        <span className="text-[10px] text-gray-400 mb-1 px-1">
                                            {isMe ? 'あなた' : '先生'}
                                        </span>
                                        <div 
                                            className={`rounded-2xl px-4 py-3 text-sm leading-relaxed shadow-sm break-words ${
                                                isMe 
                                                    ? 'bg-indigo-600 text-white rounded-tr-none' 
                                                    : 'bg-white text-gray-800 border border-gray-200 rounded-tl-none'
                                            }`}
                                        >
                                            {msg.text}
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>

                    <div className="p-4 bg-white border-t border-gray-100">
                        <form onSubmit={handleSend} className="flex gap-2">
                            <input
                                type="text"
                                value={input}
                                onChange={(e) => setInput(e.target.value)}
                                placeholder="メッセージを入力..."
                                className="flex-1 bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-indigo-100 focus:border-indigo-400 outline-none transition-all"
                                autoFocus
                            />
                            <button 
                                type="submit" 
                                disabled={!input.trim()}
                                className="px-6 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 hover:shadow-lg hover:-translate-y-0.5 disabled:opacity-50 disabled:hover:bg-indigo-600 disabled:hover:shadow-none disabled:hover:translate-y-0 transition-all flex items-center justify-center"
                            >
                                <Send className="w-5 h-5" />
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
