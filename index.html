<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClassChat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js",
        "lucide-react": "https://esm.sh/lucide-react@0.294.0"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel" data-type="module" data-presets="react,typescript">
        import React, { useState, useEffect, useRef, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        // Googleログイン用の機能を追加でインポート
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from 'firebase/auth';
        // updateDocを追加
        import { getFirestore, collection, addDoc, onSnapshot, query, where, serverTimestamp, doc, setDoc, deleteDoc, getDocs, updateDoc } from 'firebase/firestore';
        // LogIn, DoorOpen アイコンを追加
        import { MessageCircle, Users, Send, LogOut, Copy, Check, User, School, ArrowRight, AlertTriangle, Trash2, Clock, Pencil, Save, X, LogIn, DoorOpen } from 'lucide-react';

        // --- あなたのFirebase設定 ---
        const firebaseConfig = {
            apiKey: "AIzaSyC9vqXA2mLhqx2jHH4v53Jc2Jvp6rswI2s",
            authDomain: "classchat-6c29f.firebaseapp.com",
            projectId: "classchat-6c29f",
            storageBucket: "classchat-6c29f.firebasestorage.app",
            messagingSenderId: "410404733532",
            appId: "1:410404733532:web:f3076db4ef953fd8c15c99",
            measurementId: "G-S2JYFQD7E0"
        };

        // Firebaseの初期化
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider(); // Googleログインプロバイダ

        // --- アプリ本体のコード ---
        function App() {
            const [user, setUser] = useState(null);
            const [mode, setMode] = useState('landing');
            const [roomId, setRoomId] = useState('');
            const [studentName, setStudentName] = useState('');
            const [messages, setMessages] = useState([]);
            const [participants, setParticipants] = useState([]);
            const [loading, setLoading] = useState(true);
            const [authError, setAuthError] = useState(null);
            
            // 現在のルーム名（DB同期用）
            const [currentRoomName, setCurrentRoomName] = useState('');

            // ログイン状態の監視
            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            // URLパラメータのチェック
            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const roomParam = params.get('room');
                if (roomParam) setRoomId(roomParam);
            }, []);

            // ルーム情報の監視（名前などの変更をリアルタイム反映）
            useEffect(() => {
                if (!roomId) {
                    setCurrentRoomName('');
                    return;
                }
                const roomRef = doc(db, 'classroom_rooms', roomId);
                const unsubscribe = onSnapshot(roomRef, (docSnap) => {
                    if (docSnap.exists()) {
                        setCurrentRoomName(docSnap.data().name || '名称未設定');
                    }
                });
                return () => unsubscribe();
            }, [roomId]);

            // 参加者とメッセージの監視
            useEffect(() => {
                if (!user || !roomId || mode === 'landing') return;

                const participantsRef = collection(db, 'classroom_participants');
                const qParticipants = query(participantsRef, where('roomId', '==', roomId));
                const unsubParticipants = onSnapshot(qParticipants, (snapshot) => {
                    const parts = [];
                    snapshot.forEach(doc => parts.push({ id: doc.id, ...doc.data() }));
                    setParticipants(parts);
                }, (error) => console.error("Participants error:", error));

                const messagesRef = collection(db, 'classroom_messages');
                const qMessages = query(messagesRef, where('roomId', '==', roomId));
                const unsubMessages = onSnapshot(qMessages, (snapshot) => {
                    const msgs = [];
                    snapshot.forEach(doc => msgs.push({ id: doc.id, ...doc.data() }));
                    msgs.sort((a, b) => (a.timestamp?.toMillis() || Date.now()) - (b.timestamp?.toMillis() || Date.now()));
                    setMessages(msgs);
                }, (error) => console.error("Messages error:", error));

                return () => { unsubParticipants(); unsubMessages(); };
            }, [user, roomId, mode]);

            // Googleログイン処理
            const handleGoogleLogin = async () => {
                try {
                    const result = await signInWithPopup(auth, provider);
                    return result.user;
                } catch (error) {
                    console.error("Login Error:", error);
                    alert("ログインに失敗しました: " + error.message);
                    return null;
                }
            };

            // 部屋作成（名前付き）
            const createRoom = async (nameInput) => {
                // 未ログインなら先にログインさせる
                const currentUser = user || await handleGoogleLogin();
                if (!currentUser) return;

                const newRoomId = Math.random().toString(36).substring(2, 8).toUpperCase();
                setRoomId(newRoomId);
                setMode('teacher');
                
                // 名前と一緒に保存
                await setDoc(doc(db, 'classroom_rooms', newRoomId), {
                    createdAt: serverTimestamp(),
                    teacherId: currentUser.uid,
                    name: nameInput || "新しい部屋"
                });
            };

            const joinRoom = async () => {
                if (!roomId) return;
                
                // 未ログインなら先にログインさせる
                const currentUser = user || await handleGoogleLogin();
                if (!currentUser) return;

                // 名前が入力されていればそれを、空ならGoogleの名前を使う
                const finalName = studentName.trim() || currentUser.displayName || "名無し";

                await setDoc(doc(db, 'classroom_participants', currentUser.uid), {
                    roomId: roomId,
                    name: finalName,
                    joinedAt: serverTimestamp()
                });
                setMode('student');
            };

            const resumeRoom = (selectedRoomId) => {
                setRoomId(selectedRoomId);
                setMode('teacher');
            };

            // 退室処理（ログイン状態は維持）
            const handleExitRoom = () => {
                if (!window.confirm("部屋から退室しますか？")) return;
                setMode('landing');
                setRoomId('');
                setMessages([]);
                window.history.pushState({}, '', window.location.pathname);
            };

            // ログアウト処理（完全にサインアウト）
            const handleLogout = async () => {
                if (!window.confirm("ログアウトしますか？")) return;
                await signOut(auth);
                setMode('landing');
                setRoomId('');
                setMessages([]);
                window.history.pushState({}, '', window.location.pathname);
            };

            const sendMessage = async (text, targetStudentId, targetStudentName, senderType) => {
                if (!text.trim()) return;
                await addDoc(collection(db, 'classroom_messages'), {
                    roomId,
                    studentId: targetStudentId,
                    studentName: targetStudentName,
                    text: text,
                    senderType,
                    timestamp: serverTimestamp()
                });
            };

            // ルーム名変更
            const updateRoomName = async (newName) => {
                if (!roomId || !newName.trim()) return;
                const roomRef = doc(db, 'classroom_rooms', roomId);
                await updateDoc(roomRef, {
                    name: newName
                });
            };

            if (loading) return <div className="flex h-screen items-center justify-center bg-gray-50 text-gray-500">読み込み中...</div>;

            return (
                <div className="min-h-screen bg-gray-100 font-sans text-gray-800">
                    <header className="bg-white shadow-sm sticky top-0 z-10">
                        <div className="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-2 overflow-hidden">
                                <School className="text-indigo-600 w-6 h-6 flex-shrink-0" />
                                <div className="flex flex-col">
                                    <h1 className="font-bold text-lg md:text-xl text-gray-800 leading-tight">ClassChat</h1>
                                    {/* ようこそメッセージ（ログイン中のみ） */}
                                    {user && (
                                        <span className="text-xs text-gray-500 hidden md:block">
                                            ようこそ！{user.displayName}さん
                                        </span>
                                    )}
                                </div>
                            </div>
                            
                            <div className="flex items-center gap-2 md:gap-4">
                                {/* ルーム名表示 (入室中のみ) */}
                                {mode !== 'landing' && currentRoomName && (
                                    <span className="text-xs font-bold text-indigo-700 bg-indigo-50 px-2 py-1 rounded hidden lg:block truncate max-w-[150px]">
                                        {currentRoomName}
                                    </span>
                                )}

                                {/* ルームID表示 (入室中のみ) */}
                                {mode !== 'landing' && (
                                    <div className="bg-indigo-50 px-3 py-1 rounded-lg hidden md:block">
                                        <span className="text-xs text-indigo-500 uppercase font-bold mr-2">Room ID</span>
                                        <span className="font-mono font-bold text-indigo-700 text-lg">{roomId}</span>
                                    </div>
                                )}

                                {/* 退室ボタン (入室中のみ表示) */}
                                {mode !== 'landing' && (
                                    <button 
                                        onClick={handleExitRoom} 
                                        className="bg-gray-100 hover:bg-gray-200 text-gray-600 px-3 py-2 rounded-lg text-sm flex items-center gap-1 transition-colors"
                                        title="退室する（ログインしたままトップへ戻る）"
                                    >
                                        <DoorOpen className="w-4 h-4" /> <span className="hidden md:inline">退室</span>
                                    </button>
                                )}

                                {/* ログイン/ログアウトボタン */}
                                {user ? (
                                    <button 
                                        onClick={handleLogout} 
                                        className="text-gray-500 hover:text-red-500 text-sm flex items-center gap-1 px-2 py-1"
                                        title="ログアウト"
                                    >
                                        <LogOut className="w-5 h-5" /> 
                                        <span className="hidden md:inline">ログアウト</span>
                                    </button>
                                ) : (
                                    <button 
                                        onClick={handleGoogleLogin} 
                                        className="bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-bold px-4 py-2 rounded-lg flex items-center gap-1 transition-colors"
                                    >
                                        <LogIn className="w-4 h-4" /> ログイン
                                    </button>
                                )}
                            </div>
                        </div>
                    </header>
                    <main className="max-w-7xl mx-auto p-4">
                        {mode === 'landing' && (
                            <LandingView 
                                roomId={roomId} 
                                setRoomId={setRoomId} 
                                studentName={studentName} 
                                setStudentName={setStudentName} 
                                onCreateRoom={createRoom} 
                                onJoinRoom={joinRoom} 
                                user={user} 
                                onResumeRoom={resumeRoom}
                                db={db}
                                onLogin={handleGoogleLogin}
                            />
                        )}
                        {mode === 'teacher' && (
                            <TeacherDashboard 
                                roomId={roomId} 
                                roomName={currentRoomName}
                                onUpdateRoomName={updateRoomName}
                                participants={participants} 
                                messages={messages} 
                                onSendMessage={sendMessage} 
                            />
                        )}
                        {mode === 'student' && user && (
                            <StudentDashboard 
                                currentUserId={user.uid} 
                                roomName={currentRoomName}
                                messages={messages} 
                                onSendMessage={(text) => sendMessage(text, user.uid, studentName, 'student')} 
                            />
                        )}
                    </main>
                </div>
            );
        }

        // --- サブコンポーネント ---
        function LandingView({ roomId, setRoomId, studentName, setStudentName, onCreateRoom, onJoinRoom, user, onResumeRoom, db, onLogin }) {
            const [activeTab, setActiveTab] = useState('student');
            const [myRooms, setMyRooms] = useState([]);
            const [loadingRooms, setLoadingRooms] = useState(false);
            const [newRoomName, setNewRoomName] = useState(''); // 新規ルーム名用

            // 教師用タブが開かれたら、過去の部屋を取得する
            useEffect(() => {
                if (activeTab === 'teacher' && user) {
                    const fetchRooms = async () => {
                        setLoadingRooms(true);
                        try {
                            const roomsRef = collection(db, 'classroom_rooms');
                            const q = query(roomsRef, where('teacherId', '==', user.uid));
                            const snapshot = await getDocs(q);
                            const rooms = [];
                            snapshot.forEach(doc => {
                                rooms.push({ id: doc.id, ...doc.data() });
                            });
                            // クライアントサイドで日付ソート（新しい順）
                            rooms.sort((a, b) => {
                                const tA = a.createdAt?.toMillis() || 0;
                                const tB = b.createdAt?.toMillis() || 0;
                                return tB - tA;
                            });
                            setMyRooms(rooms);
                        } catch (error) {
                            console.error("Error fetching rooms:", error);
                        }
                        setLoadingRooms(false);
                    };
                    fetchRooms();
                }
            }, [activeTab, user, db]);

            const deleteRoom = async (roomIdToDelete, e) => {
                e.stopPropagation();
                if (!window.confirm('この部屋を履歴から削除しますか？\n（チャットデータは残りますが、一覧からは消えます）')) return;
                
                try {
                    await deleteDoc(doc(db, 'classroom_rooms', roomIdToDelete));
                    setMyRooms(prev => prev.filter(r => r.id !== roomIdToDelete));
                } catch (error) {
                    console.error("Delete error:", error);
                    alert("削除に失敗しました");
                }
            };

            const formatDate = (timestamp) => {
                if (!timestamp) return '';
                const date = timestamp.toDate();
                return `${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
            };

            return (
                <div className="flex flex-col items-center justify-center pt-10 px-4">
                    <div className="w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden">
                        <div className="flex border-b border-gray-100">
                            <button onClick={() => setActiveTab('student')} className={`flex-1 py-4 text-sm font-semibold flex items-center justify-center gap-2 ${activeTab === 'student' ? 'bg-indigo-50 text-indigo-600 border-b-2 border-indigo-600' : 'text-gray-500'}`}><User className="w-4 h-4" /> 生徒として参加</button>
                            <button onClick={() => setActiveTab('teacher')} className={`flex-1 py-4 text-sm font-semibold flex items-center justify-center gap-2 ${activeTab === 'teacher' ? 'bg-indigo-50 text-indigo-600 border-b-2 border-indigo-600' : 'text-gray-500'}`}><School className="w-4 h-4" /> 教師として開始</button>
                        </div>
                        <div className="p-8">
                            {activeTab === 'student' ? (
                                <div className="space-y-4">
                                    <h2 className="text-2xl font-bold text-center text-gray-800">授業に参加</h2>
                                    <div className="text-center text-xs text-gray-400 mb-2">
                                        {user ? (
                                            <span className="text-green-600 font-bold flex items-center justify-center gap-1">
                                                <Check className="w-3 h-3" /> ログイン中: {user.displayName}
                                            </span>
                                        ) : (
                                            "ログインして履歴を残すことができます"
                                        )}
                                    </div>
                                    <input type="text" value={roomId} onChange={(e) => setRoomId(e.target.value.toUpperCase())} placeholder="部屋ID (例: X7Y2Z9)" className="w-full bg-gray-50 border rounded-lg px-4 py-3 text-lg uppercase font-mono" />
                                    <input type="text" value={studentName} onChange={(e) => setStudentName(e.target.value)} placeholder="表示名 (空欄ならGoogle名)" className="w-full bg-gray-50 border rounded-lg px-4 py-3 text-lg" />
                                    <button onClick={onJoinRoom} disabled={!roomId} className="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg disabled:bg-gray-300 hover:bg-indigo-700 transition-colors flex items-center justify-center gap-2">
                                        {user ? "入室する" : "Googleでログインして入室"} <ArrowRight className="w-5 h-5" />
                                    </button>
                                </div>
                            ) : (
                                <div className="space-y-6">
                                    <div className="text-center">
                                        <h2 className="text-2xl font-bold text-gray-800">授業を開始</h2>
                                        <p className="text-gray-500 text-sm mt-1">
                                            {user ? "新しい部屋を作成します" : "Googleアカウントでログインが必要です"}
                                        </p>
                                    </div>
                                    
                                    <div className="space-y-2">
                                        <label className="block text-xs font-bold text-gray-500 uppercase text-left">ルーム名（任意）</label>
                                        <input 
                                            type="text" 
                                            value={newRoomName} 
                                            onChange={(e) => setNewRoomName(e.target.value)} 
                                            placeholder="例: 1年2組 数学" 
                                            className="w-full bg-gray-50 border rounded-lg px-4 py-3 text-base" 
                                        />
                                    </div>

                                    <button onClick={() => onCreateRoom(newRoomName)} className="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 transition-colors flex items-center justify-center gap-2">
                                        {user ? "新しい部屋を作成" : "Googleでログインして作成"} <ArrowRight className="w-5 h-5" />
                                    </button>

                                    {/* 過去の部屋リスト */}
                                    {user ? (
                                        <div className="mt-6 border-t border-gray-100 pt-4 text-left">
                                            <div className="flex items-center gap-2 text-gray-500 mb-3">
                                                <Clock className="w-4 h-4" />
                                                <span className="text-xs font-bold uppercase">最近作成した部屋</span>
                                            </div>
                                            
                                            {loadingRooms ? (
                                                <div className="text-center text-gray-400 text-xs py-4">読み込み中...</div>
                                            ) : myRooms.length === 0 ? (
                                                <div className="text-center text-gray-400 text-xs py-4">履歴はありません</div>
                                            ) : (
                                                <div className="space-y-2 max-h-60 overflow-y-auto pr-1 scrollbar-thin">
                                                    {myRooms.map(room => (
                                                        <div 
                                                            key={room.id} 
                                                            onClick={() => onResumeRoom(room.id)}
                                                            className="flex items-center justify-between p-3 bg-gray-50 border border-gray-200 rounded-lg hover:bg-indigo-50 hover:border-indigo-200 cursor-pointer group transition-all"
                                                        >
                                                            <div className="overflow-hidden">
                                                                <div className="font-bold text-gray-800 truncate">{room.name || '名称未設定'}</div>
                                                                <div className="flex items-center gap-2 mt-0.5">
                                                                    <span className="font-mono text-xs bg-indigo-100 text-indigo-700 px-1 rounded">{room.id}</span>
                                                                    <span className="text-xs text-gray-400">{formatDate(room.createdAt)}</span>
                                                                </div>
                                                            </div>
                                                            <button 
                                                                onClick={(e) => deleteRoom(room.id, e)}
                                                                className="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-full transition-colors opacity-0 group-hover:opacity-100"
                                                                title="履歴から削除"
                                                            >
                                                                <Trash2 className="w-4 h-4" />
                                                            </button>
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    ) : (
                                        <div className="mt-4 p-4 bg-gray-50 rounded-lg text-center">
                                            <p className="text-sm text-gray-500 mb-2">ログインすると過去の履歴を表示できます</p>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        function TeacherDashboard({ roomId, roomName, onUpdateRoomName, participants, messages, onSendMessage }) {
            const [copied, setCopied] = useState(false);
            const [isEditing, setIsEditing] = useState(false);
            const [editName, setEditName] = useState('');

            // 編集モード開始時に現在の名前をセット
            useEffect(() => {
                if(isEditing) setEditName(roomName);
            }, [isEditing, roomName]);

            const studentThreads = useMemo(() => {
                const threads = {};
                participants.forEach(p => threads[p.id] = []);
                messages.forEach(m => { if (!threads[m.studentId]) threads[m.studentId] = []; threads[m.studentId].push(m); });
                return threads;
            }, [participants, messages]);
            
            const copyLink = () => {
                const url = `${window.location.origin}${window.location.pathname}?room=${roomId}`;
                navigator.clipboard.writeText(url).then(() => { setCopied(true); setTimeout(() => setCopied(false), 2000); }).catch(() => prompt("URL:", url));
            };

            const handleSaveName = async () => {
                await onUpdateRoomName(editName);
                setIsEditing(false);
            };

            return (
                <div className="space-y-6">
                    {/* ヘッダーカード */}
                    <div className="bg-white p-4 rounded-xl shadow-sm border flex flex-col gap-4">
                        
                        {/* 上段：ルーム名編集エリア */}
                        <div className="flex items-center justify-between border-b border-gray-100 pb-4">
                            {isEditing ? (
                                <div className="flex items-center gap-2 w-full">
                                    <input 
                                        value={editName}
                                        onChange={(e) => setEditName(e.target.value)}
                                        className="flex-1 bg-gray-50 border rounded px-3 py-2 text-lg font-bold"
                                        placeholder="ルーム名を入力"
                                        autoFocus
                                    />
                                    <button onClick={handleSaveName} className="p-2 bg-green-100 text-green-700 rounded hover:bg-green-200"><Save className="w-5 h-5"/></button>
                                    <button onClick={() => setIsEditing(false)} className="p-2 bg-gray-100 text-gray-500 rounded hover:bg-gray-200"><X className="w-5 h-5"/></button>
                                </div>
                            ) : (
                                <div className="flex items-center gap-3 w-full">
                                    <h2 className="text-xl md:text-2xl font-bold text-gray-800 truncate">{roomName || '名称未設定'}</h2>
                                    <button 
                                        onClick={() => setIsEditing(true)} 
                                        className="p-1.5 text-gray-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors"
                                        title="ルーム名を編集"
                                    >
                                        <Pencil className="w-4 h-4" />
                                    </button>
                                </div>
                            )}
                        </div>

                        {/* 下段：ツールバー */}
                        <div className="flex flex-col md:flex-row justify-between items-center gap-4">
                            <div className="flex items-center gap-4 w-full md:w-auto">
                                <span className="font-medium flex items-center gap-2 text-gray-600">
                                    <Users className="w-5 h-5" />
                                    参加人数: <span className="text-indigo-600 font-bold text-lg">{participants.length}</span>名
                                </span>
                            </div>
                            <button onClick={copyLink} className="bg-gray-100 px-4 py-2 rounded-lg text-sm hover:bg-gray-200 transition-colors w-full md:w-auto text-center flex items-center justify-center gap-2">
                                {copied ? <Check className="w-4 h-4"/> : <Copy className="w-4 h-4"/>}
                                {copied ? 'コピー完了' : '招待リンクをコピー'}
                            </button>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                        {Object.entries(studentThreads).map(([sid, msgs]) => (
                            <ChatCard key={sid} studentId={sid} studentName={participants.find(p => p.id === sid)?.name || '不明'} messages={msgs} onSendMessage={onSendMessage} />
                        ))}
                    </div>
                </div>
            );
        }

        function ChatCard({ studentId, studentName, messages, onSendMessage }) {
            const [input, setInput] = useState('');
            const scrollRef = useRef(null);
            useEffect(() => { if (scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight; }, [messages]);
            const hasUnread = messages.length > 0 && messages[messages.length-1].senderType === 'student';

            return (
                <div className={`bg-white rounded-xl shadow-sm border h-[350px] flex flex-col ${hasUnread ? 'border-indigo-400 ring-1 ring-indigo-400' : ''}`}>
                    <div className="bg-gray-50 px-4 py-3 border-b font-bold text-sm text-gray-700 truncate">{studentName}</div>
                    <div ref={scrollRef} className="flex-1 overflow-y-auto p-3 space-y-2 bg-white">
                        {messages.map(msg => (
                            <div key={msg.id} className={`flex ${msg.senderType === 'teacher' ? 'justify-end' : 'justify-start'}`}>
                                <div className={`max-w-[90%] rounded-lg px-3 py-2 text-xs break-words ${msg.senderType === 'teacher' ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-800'}`}>{msg.text}</div>
                            </div>
                        ))}
                    </div>
                    <form onSubmit={(e) => { e.preventDefault(); if(input.trim()){ onSendMessage(input, studentId, studentName, 'teacher'); setInput(''); }}} className="p-2 border-t">
                        <div className="flex gap-2"><input value={input} onChange={e=>setInput(e.target.value)} className="flex-1 border rounded px-2 py-1 text-sm" placeholder="返信..." /><button type="submit" className="text-indigo-600"><Send className="w-4 h-4" /></button></div>
                    </form>
                </div>
            );
        }

        function StudentDashboard({ currentUserId, roomName, messages, onSendMessage }) {
            const [input, setInput] = useState('');
            const scrollRef = useRef(null);
            const myMessages = messages.filter(m => m.studentId === currentUserId);
            useEffect(() => { if (scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight; }, [myMessages]);

            return (
                <div className="max-w-2xl mx-auto h-[calc(100vh-120px)] bg-white rounded-2xl shadow-xl flex flex-col overflow-hidden border">
                    <div className="bg-indigo-50 p-4 border-b border-indigo-100">
                        <div className="text-center">
                            {roomName && <div className="text-indigo-900 font-bold mb-1">{roomName}</div>}
                            <p className="text-sm text-indigo-800 font-medium">先生に質問を送る</p>
                            <p className="text-xs text-indigo-600 opacity-70">他の生徒には見えません</p>
                        </div>
                    </div>
                    <div ref={scrollRef} className="flex-1 overflow-y-auto p-4 space-y-4">
                        {myMessages.map(msg => (
                            <div key={msg.id} className={`flex ${msg.senderType === 'student' ? 'justify-end' : 'justify-start'}`}>
                                <div className={`max-w-[80%] rounded-2xl px-4 py-3 text-sm break-words ${msg.senderType === 'student' ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-800'}`}>{msg.text}</div>
                            </div>
                        ))}
                    </div>
                    <div className="p-4 border-t"><form onSubmit={(e)=>{e.preventDefault(); if(input.trim()){ onSendMessage(input); setInput(''); }}} className="flex gap-2"><input value={input} onChange={e=>setInput(e.target.value)} className="flex-1 border rounded-xl px-4 py-3" placeholder="メッセージ..." autoFocus /><button type="submit" className="bg-indigo-600 text-white px-6 rounded-xl"><Send className="w-5 h-5" /></button></form></div>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
