<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClassChat Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js",
        "lucide-react": "https://esm.sh/lucide-react@0.294.0"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ */
        .scrollbar-thin::-webkit-scrollbar { width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div id="root"></div>

    <script type="text/babel" data-type="module" data-presets="react,typescript">
        import React, { useState, useEffect, useRef, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from 'firebase/auth';
        import { getFirestore, collection, addDoc, onSnapshot, query, where, serverTimestamp, doc, setDoc, deleteDoc, getDocs, updateDoc } from 'firebase/firestore';
        // ArrowRightã‚’è¿½åŠ ã—ã¾ã—ãŸ
        import { 
            School, User, LogIn, LogOut, DoorOpen, Copy, Check, 
            MessageCircle, Send, Trash2, Clock, Pencil, Save, X, 
            Hand, Circle, ArrowUpDown, Download, HelpCircle, ThumbsUp, CheckCircle2, ArrowRight
        } from 'lucide-react';

        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyC9vqXA2mLhqx2jHH4v53Jc2Jvp6rswI2s",
            authDomain: "classchat-6c29f.firebaseapp.com",
            projectId: "classchat-6c29f",
            storageBucket: "classchat-6c29f.firebasestorage.app",
            messagingSenderId: "410404733532",
            appId: "1:410404733532:web:f3076db4ef953fd8c15c99",
            measurementId: "G-S2JYFQD7E0"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // --- Helpers ---
        const formatTime = (timestamp) => {
            if (!timestamp) return '';
            const date = timestamp.toDate();
            return `${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
        };

        const formatDateFull = (timestamp) => {
             if (!timestamp) return '';
             const date = timestamp.toDate();
             return `${date.getFullYear()}/${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
        };

        // --- Components ---
        function App() {
            const [user, setUser] = useState(null);
            const [mode, setMode] = useState('landing');
            const [roomId, setRoomId] = useState('');
            const [studentName, setStudentName] = useState('');
            const [currentRoomName, setCurrentRoomName] = useState('');
            
            // Data
            const [messages, setMessages] = useState([]);
            const [participants, setParticipants] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const roomParam = params.get('room');
                if (roomParam) setRoomId(roomParam);
            }, []);

            // Room Metadata Listener
            useEffect(() => {
                if (!roomId) {
                    setCurrentRoomName('');
                    return;
                }
                const roomRef = doc(db, 'classroom_rooms', roomId);
                const unsubscribe = onSnapshot(roomRef, (docSnap) => {
                    if (docSnap.exists()) {
                        setCurrentRoomName(docSnap.data().name || 'åç§°æœªè¨­å®š');
                    }
                });
                return () => unsubscribe();
            }, [roomId]);

            // Main Data Listener
            useEffect(() => {
                if (!user || !roomId || mode === 'landing') return;

                const participantsRef = collection(db, 'classroom_participants');
                const qParticipants = query(participantsRef, where('roomId', '==', roomId));
                const unsubParticipants = onSnapshot(qParticipants, (snapshot) => {
                    const parts = [];
                    snapshot.forEach(doc => parts.push({ id: doc.id, ...doc.data() }));
                    setParticipants(parts);
                }, (error) => console.error("Participants error:", error));

                const messagesRef = collection(db, 'classroom_messages');
                const qMessages = query(messagesRef, where('roomId', '==', roomId));
                const unsubMessages = onSnapshot(qMessages, (snapshot) => {
                    const msgs = [];
                    snapshot.forEach(doc => msgs.push({ id: doc.id, ...doc.data() }));
                    msgs.sort((a, b) => (a.timestamp?.toMillis() || Date.now()) - (b.timestamp?.toMillis() || Date.now()));
                    setMessages(msgs);
                }, (error) => console.error("Messages error:", error));

                return () => { unsubParticipants(); unsubMessages(); };
            }, [user, roomId, mode]);

            // Actions
            const handleGoogleLogin = async () => {
                try {
                    const result = await signInWithPopup(auth, provider);
                    return result.user;
                } catch (error) {
                    alert("ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼: " + error.message);
                    return null;
                }
            };

            const createRoom = async (nameInput) => {
                const currentUser = user || await handleGoogleLogin();
                if (!currentUser) return;
                const newRoomId = Math.random().toString(36).substring(2, 8).toUpperCase();
                setRoomId(newRoomId);
                setMode('teacher');
                await setDoc(doc(db, 'classroom_rooms', newRoomId), {
                    createdAt: serverTimestamp(),
                    teacherId: currentUser.uid,
                    name: nameInput || "æ–°ã—ã„éƒ¨å±‹"
                });
            };

            const joinRoom = async () => {
                if (!roomId) return;
                const currentUser = user || await handleGoogleLogin();
                if (!currentUser) return;
                const finalName = studentName.trim() || currentUser.displayName || "åç„¡ã—";
                await setDoc(doc(db, 'classroom_participants', currentUser.uid), {
                    roomId: roomId,
                    name: finalName,
                    joinedAt: serverTimestamp(),
                    handRaised: false, // åˆæœŸçŠ¶æ…‹
                    vote: null         // åˆæœŸçŠ¶æ…‹
                });
                setMode('student');
            };

            const resumeRoom = (id) => { setRoomId(id); setMode('teacher'); };

            const handleExit = () => {
                if(!confirm("é€€å®¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
                setMode('landing');
                setRoomId('');
                setMessages([]);
                window.history.pushState({}, '', window.location.pathname);
            };

            const handleLogout = async () => {
                if(!confirm("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ")) return;
                await signOut(auth);
                setMode('landing');
                setRoomId('');
                setMessages([]);
            };

            const sendMessage = async (text, targetStudentId, targetStudentName, senderType) => {
                if (!text.trim()) return;
                await addDoc(collection(db, 'classroom_messages'), {
                    roomId,
                    studentId: targetStudentId,
                    studentName: targetStudentName,
                    text: text,
                    senderType,
                    timestamp: serverTimestamp(),
                    deleted: false
                });
            };

            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‰Šé™¤ï¼ˆè«–ç†å‰Šé™¤ï¼‰
            const deleteMessage = async (msgId) => {
                if(!confirm("ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
                await updateDoc(doc(db, 'classroom_messages', msgId), {
                    deleted: true,
                    text: 'ï¼ˆå‰Šé™¤ã•ã‚Œã¾ã—ãŸï¼‰'
                });
            };

            const updateRoomName = async (newName) => {
                if (!roomId || !newName.trim()) return;
                await updateDoc(doc(db, 'classroom_rooms', roomId), { name: newName });
            };

            // ç”Ÿå¾’ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ›´æ–°
            const updateParticipantStatus = async (uid, data) => {
                await updateDoc(doc(db, 'classroom_participants', uid), data);
            };

            if (loading) return <div className="flex h-screen items-center justify-center text-gray-500">èª­ã¿è¾¼ã¿ä¸­...</div>;

            return (
                <div className="min-h-screen flex flex-col font-sans">
                    <header className="bg-white shadow-sm sticky top-0 z-20 h-14 md:h-16 flex items-center justify-between px-4">
                        <div className="flex items-center gap-2 overflow-hidden">
                            <School className="text-indigo-600 w-5 h-5 md:w-6 md:h-6 flex-shrink-0" />
                            <div className="flex flex-col">
                                <h1 className="font-bold text-base md:text-lg leading-tight">ClassChat <span className="text-indigo-600">Pro</span></h1>
                                {user && <span className="text-xs text-gray-500 hidden md:block">ã‚ˆã†ã“ãï¼{user.displayName}ã•ã‚“</span>}
                            </div>
                        </div>
                        <div className="flex items-center gap-2">
                            {mode !== 'landing' && currentRoomName && (
                                <span className="text-xs font-bold text-indigo-700 bg-indigo-50 px-2 py-1 rounded hidden lg:block truncate max-w-[150px]">{currentRoomName}</span>
                            )}
                            {mode !== 'landing' && (
                                <>
                                    <div className="bg-indigo-50 px-2 py-1 rounded hidden md:block">
                                        <span className="text-[10px] text-indigo-500 font-bold mr-1">ID</span>
                                        <span className="font-mono font-bold text-indigo-700">{roomId}</span>
                                    </div>
                                    <button onClick={handleExit} className="bg-gray-100 hover:bg-gray-200 text-gray-600 px-3 py-1.5 rounded text-xs flex items-center gap-1"><DoorOpen className="w-3 h-3"/> é€€å®¤</button>
                                </>
                            )}
                            {user ? (
                                <button onClick={handleLogout} className="text-gray-400 hover:text-red-500 px-2"><LogOut className="w-4 h-4"/></button>
                            ) : (
                                <button onClick={handleGoogleLogin} className="bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-bold px-3 py-2 rounded flex items-center gap-1"><LogIn className="w-3 h-3"/> ãƒ­ã‚°ã‚¤ãƒ³</button>
                            )}
                        </div>
                    </header>
                    <main className="flex-1 max-w-[1600px] w-full mx-auto p-2 md:p-4">
                        {mode === 'landing' && (
                            <LandingView 
                                roomId={roomId} setRoomId={setRoomId} studentName={studentName} setStudentName={setStudentName}
                                onCreateRoom={createRoom} onJoinRoom={joinRoom} user={user} onResumeRoom={resumeRoom} db={db}
                            />
                        )}
                        {mode === 'teacher' && (
                            <TeacherDashboard 
                                roomId={roomId} roomName={currentRoomName} onUpdateRoomName={updateRoomName}
                                participants={participants} messages={messages} onSendMessage={sendMessage}
                                onDeleteMessage={deleteMessage}
                            />
                        )}
                        {mode === 'student' && user && (
                            <StudentDashboard 
                                user={user} roomName={currentRoomName}
                                messages={messages} onSendMessage={sendMessage} onDeleteMessage={deleteMessage}
                                onUpdateStatus={updateParticipantStatus} participants={participants}
                            />
                        )}
                    </main>
                </div>
            );
        }

        // --- Landing View ---
        function LandingView({ roomId, setRoomId, studentName, setStudentName, onCreateRoom, onJoinRoom, user, onResumeRoom, db }) {
            const [activeTab, setActiveTab] = useState('student');
            const [myRooms, setMyRooms] = useState([]);
            const [newRoomName, setNewRoomName] = useState('');

            useEffect(() => {
                if (activeTab === 'teacher' && user) {
                    const q = query(collection(db, 'classroom_rooms'), where('teacherId', '==', user.uid));
                    getDocs(q).then(snap => {
                        const rooms = [];
                        snap.forEach(d => rooms.push({ id: d.id, ...d.data() }));
                        rooms.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
                        setMyRooms(rooms);
                    });
                }
            }, [activeTab, user]);

            const deleteRoom = async (rid, e) => {
                e.stopPropagation();
                if(!confirm('å±¥æ­´ã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
                await deleteDoc(doc(db, 'classroom_rooms', rid));
                setMyRooms(prev => prev.filter(r => r.id !== rid));
            };

            return (
                <div className="flex flex-col items-center pt-8 px-4">
                    <div className="w-full max-w-md bg-white rounded-xl shadow-lg overflow-hidden">
                        <div className="flex border-b border-gray-100">
                            <button onClick={()=>setActiveTab('student')} className={`flex-1 py-3 text-sm font-bold flex items-center justify-center gap-2 ${activeTab === 'student' ? 'bg-indigo-50 text-indigo-600 border-b-2 border-indigo-600' : 'text-gray-500'}`}><User className="w-4 h-4"/> ç”Ÿå¾’</button>
                            <button onClick={()=>setActiveTab('teacher')} className={`flex-1 py-3 text-sm font-bold flex items-center justify-center gap-2 ${activeTab === 'teacher' ? 'bg-indigo-50 text-indigo-600 border-b-2 border-indigo-600' : 'text-gray-500'}`}><School className="w-4 h-4"/> æ•™å¸«</button>
                        </div>
                        <div className="p-6 space-y-4">
                            {activeTab === 'student' ? (
                                <>
                                    <h2 className="text-lg font-bold text-center">æˆæ¥­ã«å‚åŠ </h2>
                                    <input value={roomId} onChange={e=>setRoomId(e.target.value.toUpperCase())} placeholder="éƒ¨å±‹ID (ä¾‹: X7Y2Z9)" className="w-full bg-gray-50 border rounded-lg px-4 py-3 uppercase font-mono" />
                                    <input value={studentName} onChange={e=>setStudentName(e.target.value)} placeholder="è¡¨ç¤ºå (ç©ºæ¬„ãªã‚‰Googleå)" className="w-full bg-gray-50 border rounded-lg px-4 py-3" />
                                    <button onClick={onJoinRoom} disabled={!roomId} className="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 flex items-center justify-center gap-2">{user ? "å…¥å®¤" : "Googleã§å…¥å®¤"} <ArrowRight className="w-4 h-4"/></button>
                                </>
                            ) : (
                                <>
                                    <h2 className="text-lg font-bold text-center">æˆæ¥­ã‚’é–‹å§‹</h2>
                                    <input value={newRoomName} onChange={e=>setNewRoomName(e.target.value)} placeholder="ãƒ«ãƒ¼ãƒ å (ä¾‹: æ•°å­¦IA)" className="w-full bg-gray-50 border rounded-lg px-4 py-3" />
                                    <button onClick={()=>onCreateRoom(newRoomName)} className="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 flex items-center justify-center gap-2">{user ? "ä½œæˆ" : "Googleã§ä½œæˆ"} <ArrowRight className="w-4 h-4"/></button>
                                    
                                    {user && myRooms.length > 0 && (
                                        <div className="mt-4 pt-4 border-t border-gray-100">
                                            <p className="text-xs font-bold text-gray-500 mb-2">å±¥æ­´</p>
                                            <div className="max-h-48 overflow-y-auto space-y-2">
                                                {myRooms.map(r => (
                                                    <div key={r.id} onClick={()=>onResumeRoom(r.id)} className="flex justify-between items-center p-2 bg-gray-50 border rounded hover:bg-indigo-50 cursor-pointer group">
                                                        <div className="truncate flex-1">
                                                            <div className="font-bold text-sm truncate">{r.name}</div>
                                                            <div className="text-[10px] text-gray-400 font-mono">{r.id}</div>
                                                        </div>
                                                        <button onClick={(e)=>deleteRoom(r.id,e)} className="p-1.5 text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100"><Trash2 className="w-3 h-3"/></button>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // --- Teacher Dashboard ---
        function TeacherDashboard({ roomId, roomName, onUpdateRoomName, participants, messages, onSendMessage, onDeleteMessage }) {
            const [isEditing, setIsEditing] = useState(false);
            const [editName, setEditName] = useState('');
            const [sortMode, setSortMode] = useState('join'); // 'join' | 'name'
            const [copied, setCopied] = useState(false);

            useEffect(() => { if(isEditing) setEditName(roomName); }, [isEditing, roomName]);

            // CSV Export
            const handleExport = () => {
                const header = "æ—¥æ™‚,é€ä¿¡è€…ID,é€ä¿¡è€…å,ç¨®åˆ¥,ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸\n";
                const rows = messages.map(m => {
                    const time = formatDateFull(m.timestamp);
                    const text = m.text.replace(/"/g, '""'); // CSV escape
                    return `"${time}","${m.studentId}","${m.studentName}","${m.senderType}","${text}"`;
                }).join("\n");
                
                const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), header + rows], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `chat_log_${roomId}_${new Date().toISOString().slice(0,10)}.csv`;
                link.click();
            };

            const copyLink = () => {
                const url = `${window.location.origin}${window.location.pathname}?room=${roomId}`;
                navigator.clipboard.writeText(url).then(() => { setCopied(true); setTimeout(() => setCopied(false), 2000); }).catch(() => prompt("URL:", url));
            };

            // Sorting & Grouping
            const studentThreads = useMemo(() => {
                // ç”Ÿå¾’ãƒªã‚¹ãƒˆã‚’ä¸¦ã¹æ›¿ãˆ
                const sortedParticipants = [...participants].sort((a, b) => {
                    if (sortMode === 'name') return a.name.localeCompare(b.name, 'ja');
                    return (a.joinedAt?.toMillis() || 0) - (b.joinedAt?.toMillis() || 0);
                });

                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒãƒƒãƒ”ãƒ³ã‚°
                const threads = [];
                sortedParticipants.forEach(p => {
                    const msgs = messages.filter(m => m.studentId === p.id);
                    threads.push({ participant: p, messages: msgs });
                });
                return threads;
            }, [participants, messages, sortMode]);

            return (
                <div className="space-y-4 h-[calc(100vh-80px)] flex flex-col">
                    {/* Toolbar */}
                    <div className="bg-white p-3 rounded-xl shadow-sm border flex flex-wrap gap-3 items-center justify-between flex-shrink-0">
                        <div className="flex items-center gap-2 flex-1 min-w-[200px]">
                            {isEditing ? (
                                <div className="flex gap-1 w-full max-w-xs">
                                    <input value={editName} onChange={e=>setEditName(e.target.value)} className="flex-1 border rounded px-2 py-1 text-sm font-bold" autoFocus />
                                    <button onClick={()=>{onUpdateRoomName(editName); setIsEditing(false)}} className="bg-green-100 text-green-700 p-1 rounded"><Save className="w-4 h-4"/></button>
                                </div>
                            ) : (
                                <div className="flex items-center gap-2 cursor-pointer hover:bg-gray-50 px-2 py-1 rounded" onClick={()=>setIsEditing(true)}>
                                    <h2 className="text-lg font-bold truncate max-w-[200px]">{roomName || 'åç§°æœªè¨­å®š'}</h2>
                                    <Pencil className="w-3 h-3 text-gray-400"/>
                                </div>
                            )}
                            <span className="text-xs bg-gray-100 px-2 py-1 rounded text-gray-500 font-bold">{participants.length}å</span>
                        </div>
                        
                        <div className="flex gap-2">
                            <button onClick={copyLink} className="flex items-center gap-1 px-3 py-1.5 bg-indigo-50 hover:bg-indigo-100 text-indigo-700 text-xs rounded font-bold transition">
                                {copied ? <Check className="w-3 h-3"/> : <Copy className="w-3 h-3"/>} {copied ? 'ã‚³ãƒ”ãƒ¼å®Œäº†' : 'æ‹›å¾…ãƒªãƒ³ã‚¯'}
                            </button>
                            <button onClick={()=>setSortMode(s => s === 'join' ? 'name' : 'join')} className="flex items-center gap-1 px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-xs rounded font-bold transition">
                                <ArrowUpDown className="w-3 h-3"/> {sortMode === 'join' ? 'å…¥å®¤é †' : 'æ°åé †'}
                            </button>
                            <button onClick={handleExport} className="flex items-center gap-1 px-3 py-1.5 bg-green-50 hover:bg-green-100 text-green-700 text-xs rounded font-bold transition">
                                <Download className="w-3 h-3"/> ãƒ­ã‚°ä¿å­˜
                            </button>
                        </div>
                    </div>

                    {/* Compact Grid */}
                    <div className="flex-1 overflow-y-auto pr-1">
                        <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-6 gap-3 pb-10">
                            {studentThreads.map(({ participant, messages }) => (
                                <CompactChatCard 
                                    key={participant.id} 
                                    participant={participant} 
                                    messages={messages} 
                                    onSendMessage={onSendMessage}
                                    onDeleteMessage={onDeleteMessage}
                                />
                            ))}
                        </div>
                    </div>
                </div>
            );
        }

        // --- Compact Chat Card (Teacher) ---
        function CompactChatCard({ participant, messages, onSendMessage, onDeleteMessage }) {
            const [input, setInput] = useState('');
            const scrollRef = useRef(null);

            useEffect(() => { if (scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight; }, [messages]);

            const lastMsg = messages[messages.length - 1];
            // æœªèª­å¼·èª¿: æœ€å¾ŒãŒã€Œç”Ÿå¾’ã€ã‹ã¤ã€Œå‰Šé™¤ã•ã‚Œã¦ã„ãªã„ã€
            const isUnread = lastMsg && lastMsg.senderType === 'student' && !lastMsg.deleted;
            // æŒ™æ‰‹çŠ¶æ…‹
            const isHandRaised = participant.handRaised;

            const sendQuick = (text) => onSendMessage(text, participant.id, participant.name, 'teacher');

            return (
                <div className={`
                    bg-white rounded-lg border shadow-sm flex flex-col h-[320px] overflow-hidden transition-all relative
                    ${isHandRaised ? 'bg-red-50 border-red-300 ring-2 ring-red-200' : ''}
                    ${isUnread && !isHandRaised ? 'border-orange-400 ring-2 ring-orange-100' : 'border-gray-200'}
                `}>
                    {/* Header */}
                    <div className={`px-3 py-2 border-b flex justify-between items-center ${isHandRaised ? 'bg-red-100' : 'bg-gray-50'}`}>
                        <div className="truncate font-bold text-sm flex-1" title={participant.name}>{participant.name}</div>
                        <div className="flex gap-1">
                            {participant.vote === 'O' && <div className="text-green-600 bg-white rounded-full p-0.5"><Circle className="w-4 h-4"/></div>}
                            {participant.vote === 'X' && <div className="text-red-600 bg-white rounded-full p-0.5"><X className="w-4 h-4"/></div>}
                            {isHandRaised && <Hand className="w-4 h-4 text-red-500 animate-bounce"/>}
                        </div>
                    </div>

                    {/* Messages */}
                    <div ref={scrollRef} className="flex-1 overflow-y-auto p-2 space-y-2 bg-white/50 text-xs">
                        {messages.length === 0 && <div className="text-center text-gray-300 mt-4">- No Data -</div>}
                        {messages.map(msg => {
                            const isTeacher = msg.senderType === 'teacher';
                            return (
                                <div key={msg.id} className={`flex ${isTeacher ? 'justify-end' : 'justify-start'}`}>
                                    <div className={`max-w-[90%] rounded px-2 py-1.5 break-words group relative ${
                                        msg.deleted ? 'bg-gray-100 text-gray-400 italic border' : 
                                        isTeacher ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-800'
                                    }`}>
                                        {msg.text}
                                        <div className={`text-[9px] mt-0.5 text-right opacity-70 ${isTeacher ? 'text-indigo-100' : 'text-gray-400'}`}>
                                            {formatTime(msg.timestamp)}
                                        </div>
                                        {!msg.deleted && isTeacher && (
                                            <button onClick={()=>onDeleteMessage(msg.id)} className="absolute -left-4 top-0 text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100">
                                                <Trash2 className="w-3 h-3"/>
                                            </button>
                                        )}
                                    </div>
                                </div>
                            );
                        })}
                    </div>

                    {/* Quick Actions & Input */}
                    <div className="p-2 border-t bg-gray-50 space-y-2">
                        <div className="flex justify-between gap-1">
                            <button onClick={()=>sendQuick("å…·ä½“çš„ã«æ•™ãˆã¦ğŸ™‡")} className="flex-1 bg-white border border-gray-200 text-[10px] py-1 rounded hover:bg-gray-100">å…·ä½“çš„ã«?</button>
                            <button onClick={()=>sendQuick("äº†è§£ã—ã¾ã—ãŸğŸ«¡")} className="flex-1 bg-white border border-gray-200 text-[10px] py-1 rounded hover:bg-gray-100">äº†è§£ğŸ«¡</button>
                            <button onClick={()=>sendQuick("ç´ æ™´ã‚‰ã—ã„ï¼ğŸ‘")} className="flex-1 bg-white border border-gray-200 text-[10px] py-1 rounded hover:bg-gray-100">ğŸ‘</button>
                        </div>
                        <form onSubmit={(e)=>{e.preventDefault(); if(input.trim()){ onSendMessage(input, participant.id, participant.name, 'teacher'); setInput('');}}} className="flex gap-1">
                            <input value={input} onChange={e=>setInput(e.target.value)} className="flex-1 border rounded px-2 py-1 text-xs" placeholder="å…¥åŠ›..." />
                            <button type="submit" className="bg-indigo-600 text-white px-2 rounded"><Send className="w-3 h-3"/></button>
                        </form>
                    </div>
                </div>
            );
        }

        // --- Student Dashboard ---
        function StudentDashboard({ user, roomName, messages, onSendMessage, onDeleteMessage, onUpdateStatus, participants }) {
            const [input, setInput] = useState('');
            const scrollRef = useRef(null);
            
            // è‡ªåˆ†ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å–å¾—
            const myStatus = participants.find(p => p.id === user.uid) || {};
            const myMessages = messages.filter(m => m.studentId === user.uid);

            useEffect(() => { if (scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight; }, [myMessages]);

            const toggleHand = () => onUpdateStatus(user.uid, { handRaised: !myStatus.handRaised });
            const castVote = (val) => onUpdateStatus(user.uid, { vote: myStatus.vote === val ? null : val });

            return (
                <div className="max-w-xl mx-auto h-[calc(100vh-80px)] bg-white rounded-xl shadow-lg flex flex-col border overflow-hidden">
                    {/* Status Bar */}
                    <div className="bg-indigo-50 p-2 flex justify-around items-center border-b border-indigo-100">
                        <button onClick={toggleHand} className={`flex flex-col items-center gap-1 p-2 rounded-lg w-20 transition-all ${myStatus.handRaised ? 'bg-red-500 text-white shadow-md scale-105' : 'bg-white text-gray-600 border'}`}>
                            <Hand className="w-5 h-5"/> <span className="text-[10px] font-bold">æŒ™æ‰‹</span>
                        </button>
                        <div className="h-8 w-px bg-indigo-200 mx-2"></div>
                        <div className="flex gap-2">
                             <button onClick={()=>castVote('O')} className={`flex flex-col items-center gap-1 p-2 rounded-lg w-16 transition-all ${myStatus.vote === 'O' ? 'bg-green-500 text-white shadow-md' : 'bg-white text-gray-600 border'}`}>
                                <Circle className="w-5 h-5"/> <span className="text-[10px] font-bold">ã¾ã‚‹</span>
                            </button>
                            <button onClick={()=>castVote('X')} className={`flex flex-col items-center gap-1 p-2 rounded-lg w-16 transition-all ${myStatus.vote === 'X' ? 'bg-red-500 text-white shadow-md' : 'bg-white text-gray-600 border'}`}>
                                <X className="w-5 h-5"/> <span className="text-[10px] font-bold">ã°ã¤</span>
                            </button>
                        </div>
                    </div>

                    {/* Messages */}
                    <div ref={scrollRef} className="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50">
                        {myMessages.length === 0 && <div className="text-center text-gray-400 text-sm mt-10">è³ªå•ã‚„æ„è¦‹ã‚’é€ã£ã¦ã¿ã¾ã—ã‚‡ã†</div>}
                        {myMessages.map(msg => (
                            <div key={msg.id} className={`flex ${msg.senderType === 'student' ? 'justify-end' : 'justify-start'}`}>
                                <div className={`max-w-[85%] rounded-xl px-4 py-2 text-sm break-words relative group ${
                                    msg.deleted ? 'bg-gray-200 text-gray-500 italic border' :
                                    msg.senderType === 'student' ? 'bg-indigo-600 text-white' : 'bg-white text-gray-800 border'
                                }`}>
                                    {msg.text}
                                    <div className={`text-[10px] mt-1 text-right opacity-70 ${msg.senderType === 'student' ? 'text-indigo-100' : 'text-gray-400'}`}>
                                        {formatTime(msg.timestamp)}
                                    </div>
                                    {!msg.deleted && msg.senderType === 'student' && (
                                        <button onClick={()=>onDeleteMessage(msg.id)} className="absolute -left-8 top-1/2 -translate-y-1/2 text-gray-300 hover:text-red-500 p-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                            <Trash2 className="w-4 h-4"/>
                                        </button>
                                    )}
                                </div>
                            </div>
                        ))}
                    </div>

                    {/* Input */}
                    <div className="p-3 bg-white border-t">
                        <form onSubmit={(e)=>{e.preventDefault(); if(input.trim()){ onSendMessage(input); setInput(''); }}} className="flex gap-2">
                            <input value={input} onChange={e=>setInput(e.target.value)} className="flex-1 border rounded-lg px-3 py-2" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸..." />
                            <button type="submit" className="bg-indigo-600 text-white px-4 rounded-lg"><Send className="w-5 h-5"/></button>
                        </form>
                    </div>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
