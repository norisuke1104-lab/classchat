<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Chat (Œ≤Áâà)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js",
        "lucide-react": "https://esm.sh/lucide-react@0.294.0"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        .scrollbar-thin::-webkit-scrollbar { width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        /* „Çπ„É©„Ç§„ÉÄ„Éº„ÅÆ„Ç´„Çπ„Çø„É†„Çπ„Çø„Ç§„É´ */
        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #4f46e5;
            cursor: pointer;
            margin-top: -6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #cbd5e1;
            border-radius: 2px;
        }
        input[type=range]:focus {
            outline: none;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div id="root"></div>

    <script type="text/babel" data-type="module" data-presets="react,typescript">
        import React, { useState, useEffect, useRef, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, signInAnonymously } from 'firebase/auth';
        import { getFirestore, collection, addDoc, onSnapshot, query, where, serverTimestamp, doc, setDoc, deleteDoc, getDocs, updateDoc, getDoc, writeBatch } from 'firebase/firestore';
        // LayoutGrid„ÇíËøΩÂä†
        import { 
            School, User, LogIn, LogOut, DoorOpen, Copy, Check, 
            MessageCircle, Send, Trash2, Clock, Pencil, Save, X, 
            Hand, Circle, ArrowUpDown, Download, HelpCircle, ThumbsUp, CheckCircle2, ArrowRight, Megaphone, Eye, LayoutGrid
        } from 'lucide-react';

        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyC9vqXA2mLhqx2jHH4v53Jc2Jvp6rswI2s",
            authDomain: "classchat-6c29f.firebaseapp.com",
            projectId: "classchat-6c29f",
            storageBucket: "classchat-6c29f.firebasestorage.app",
            messagingSenderId: "410404733532",
            appId: "1:410404733532:web:f3076db4ef953fd8c15c99",
            measurementId: "G-S2JYFQD7E0"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // --- Helpers ---
        const formatTime = (timestamp) => {
            if (!timestamp) return '';
            const date = timestamp.toDate();
            return `${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
        };

        const formatDateFull = (timestamp) => {
             if (!timestamp) return '';
             const date = timestamp.toDate();
             return `${date.getFullYear()}/${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
        };

        const isSameDay = (t1, t2) => {
            if (!t1 || !t2) return false;
            const d1 = t1.toDate();
            const d2 = t2.toDate();
            return d1.getFullYear() === d2.getFullYear() &&
                   d1.getMonth() === d2.getMonth() &&
                   d1.getDate() === d2.getDate();
        };

        const formatDateShort = (timestamp) => {
            if (!timestamp) return '';
            const d = timestamp.toDate();
            return `${d.getMonth() + 1}/${d.getDate()}`;
        };

        // --- Components ---
        function App() {
            const [user, setUser] = useState(null);
            const [mode, setMode] = useState('landing');
            const [roomId, setRoomId] = useState('');
            const [studentName, setStudentName] = useState('');
            const [currentRoomName, setCurrentRoomName] = useState('');
            
            // Data
            const [messages, setMessages] = useState([]);
            const [participants, setParticipants] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const roomParam = params.get('room');
                if (roomParam) setRoomId(roomParam);
            }, []);

            // Room Metadata Listener
            useEffect(() => {
                if (!roomId) {
                    setCurrentRoomName('');
                    return;
                }
                const roomRef = doc(db, 'classroom_rooms', roomId);
                const unsubscribe = onSnapshot(roomRef, (docSnap) => {
                    if (docSnap.exists()) {
                        setCurrentRoomName(docSnap.data().name || 'ÂêçÁß∞Êú™Ë®≠ÂÆö');
                    }
                });
                return () => unsubscribe();
            }, [roomId]);

            // Main Data Listener
            useEffect(() => {
                if (!user || !roomId || mode === 'landing') return;

                const participantsRef = collection(db, 'classroom_participants');
                const qParticipants = query(participantsRef, where('roomId', '==', roomId));
                const unsubParticipants = onSnapshot(qParticipants, (snapshot) => {
                    const parts = [];
                    snapshot.forEach(doc => parts.push({ id: doc.id, ...doc.data() }));
                    setParticipants(parts);
                }, (error) => console.error("Participants error:", error));

                const messagesRef = collection(db, 'classroom_messages');
                const qMessages = query(messagesRef, where('roomId', '==', roomId));
                const unsubMessages = onSnapshot(qMessages, (snapshot) => {
                    const msgs = [];
                    snapshot.forEach(doc => msgs.push({ id: doc.id, ...doc.data() }));
                    msgs.sort((a, b) => (a.timestamp?.toMillis() || Date.now()) - (b.timestamp?.toMillis() || Date.now()));
                    setMessages(msgs);
                }, (error) => console.error("Messages error:", error));

                return () => { unsubParticipants(); unsubMessages(); };
            }, [user, roomId, mode]);

            // Actions
            const handleGoogleLogin = async () => {
                try {
                    const result = await signInWithPopup(auth, provider);
                    return result.user;
                } catch (error) {
                    alert("„É≠„Ç∞„Ç§„É≥„Ç®„É©„Éº: " + error.message);
                    return null;
                }
            };

            const handleGuestLogin = async () => {
                try {
                    const result = await signInAnonymously(auth);
                    return result.user;
                } catch (error) {
                    alert("„Ç≤„Çπ„ÉàÂÖ•ÂÆ§„Ç®„É©„Éº: " + error.message);
                    return null;
                }
            };

            const createRoom = async (nameInput, userOverride) => {
                const currentUser = userOverride || user || await handleGoogleLogin();
                if (!currentUser) return;
                
                const newRoomId = Math.random().toString(36).substring(2, 8).toUpperCase();
                setRoomId(newRoomId);
                setMode('teacher');
                await setDoc(doc(db, 'classroom_rooms', newRoomId), {
                    createdAt: serverTimestamp(),
                    teacherId: currentUser.uid,
                    name: nameInput || "Êñ∞„Åó„ÅÑÈÉ®Â±ã"
                });
            };

            const joinRoom = async (userOverride) => {
                if (!roomId) return;
                const currentUser = userOverride || user;
                if (!currentUser) return;

                const finalName = studentName.trim() || currentUser.displayName || "ÂêçÁÑ°„Åó";
                await setDoc(doc(db, 'classroom_participants', currentUser.uid), {
                    roomId: roomId,
                    name: finalName,
                    joinedAt: serverTimestamp(),
                    handRaised: false,
                    vote: null
                });
                setMode('student');
            };

            const resumeRoom = (id) => { setRoomId(id); setMode('teacher'); };

            const handleExit = () => {
                if(!confirm("ÈÄÄÂÆ§„Åó„Åæ„Åô„ÅãÔºü")) return;
                setMode('landing');
                setRoomId('');
                setMessages([]);
                window.history.pushState({}, '', window.location.pathname);
            };

            const forceExit = () => {
                setMode('landing');
                setRoomId('');
                setMessages([]);
                window.history.pushState({}, '', window.location.pathname);
            };

            const handleLogout = async () => {
                if(!confirm("„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åô„ÅãÔºü")) return;
                await signOut(auth);
                setMode('landing');
                setRoomId('');
                setMessages([]);
            };

            const sendMessage = async (text, targetStudentId, targetStudentName, senderType) => {
                if (!text.trim()) return;
                await addDoc(collection(db, 'classroom_messages'), {
                    roomId,
                    studentId: targetStudentId,
                    studentName: targetStudentName,
                    text: text,
                    senderType,
                    timestamp: serverTimestamp(),
                    deleted: false,
                    read: false
                });
            };

            const deleteMessage = async (msgId) => {
                if(!confirm("„Åì„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü")) return;
                await updateDoc(doc(db, 'classroom_messages', msgId), {
                    deleted: true,
                    text: 'ÔºàÂâäÈô§„Åï„Çå„Åæ„Åó„ÅüÔºâ'
                });
            };

            const updateRoomName = async (newName) => {
                if (!roomId || !newName.trim()) return;
                await updateDoc(doc(db, 'classroom_rooms', roomId), { name: newName });
            };

            const updateParticipantStatus = async (uid, data) => {
                await updateDoc(doc(db, 'classroom_participants', uid), data);
            };

            const lowerAllHands = async () => {
                if(!confirm("ÂÖ®Âì°„ÅÆÊâã„Çí‰∏ã„Åí„Åï„Åõ„Åæ„Åô„ÅãÔºü")) return;
                const batch = writeBatch(db);
                participants.forEach(p => {
                    if (p.handRaised) {
                        const ref = doc(db, 'classroom_participants', p.id);
                        batch.update(ref, { handRaised: false });
                    }
                });
                await batch.commit();
            };

            const markAsRead = async (messageId) => {
                try {
                    await updateDoc(doc(db, 'classroom_messages', messageId), { read: true });
                } catch(e) { console.error("Read mark error", e); }
            };

            if (loading) return <div className="flex h-screen items-center justify-center text-gray-500">Ë™≠„ÅøËæº„Åø‰∏≠...</div>;

            return (
                <div className="min-h-screen flex flex-col font-sans">
                    <header className="bg-white shadow-sm sticky top-0 z-20 h-14 md:h-16 flex items-center justify-between px-4">
                        <div className="flex items-center gap-2 overflow-hidden">
                            <School className="text-indigo-600 w-5 h-5 md:w-6 md:h-6 flex-shrink-0" />
                            <div className="flex flex-col">
                                <h1 className="font-bold text-base md:text-lg leading-tight">Class Chat <span className="text-indigo-600 text-xs font-normal align-middle">(Œ≤Áâà)</span></h1>
                                {user && <span className="text-xs text-gray-500 hidden md:block">„Çà„ÅÜ„Åì„ÅùÔºÅ{user.isAnonymous ? '„Ç≤„Çπ„Éà' : user.displayName}„Åï„Çì</span>}
                            </div>
                        </div>
                        <div className="flex items-center gap-2">
                            {mode !== 'landing' && currentRoomName && (
                                <span className="text-xs font-bold text-indigo-700 bg-indigo-50 px-2 py-1 rounded hidden lg:block truncate max-w-[150px]">{currentRoomName}</span>
                            )}
                            {mode !== 'landing' && (
                                <>
                                    <div className="bg-indigo-50 px-2 py-1 rounded hidden md:block">
                                        <span className="text-[10px] text-indigo-500 font-bold mr-1">ID</span>
                                        <span className="font-mono font-bold text-indigo-700">{roomId}</span>
                                    </div>
                                    <button onClick={handleExit} className="bg-gray-100 hover:bg-gray-200 text-gray-600 px-3 py-1.5 rounded text-xs flex items-center gap-1"><DoorOpen className="w-3 h-3"/> ÈÄÄÂÆ§</button>
                                </>
                            )}
                            {user ? (
                                <button onClick={handleLogout} className="text-gray-400 hover:text-red-500 px-2"><LogOut className="w-4 h-4"/></button>
                            ) : (
                                <button onClick={handleGoogleLogin} className="bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-bold px-3 py-2 rounded flex items-center gap-1"><LogIn className="w-3 h-3"/> „É≠„Ç∞„Ç§„É≥</button>
                            )}
                        </div>
                    </header>
                    <main className="flex-1 max-w-[1600px] w-full mx-auto p-2 md:p-4">
                        {mode === 'landing' && (
                            <LandingView 
                                roomId={roomId} setRoomId={setRoomId} studentName={studentName} setStudentName={setStudentName}
                                onCreateRoom={createRoom} onJoinRoom={joinRoom} 
                                onLogin={handleGoogleLogin} onLoginGuest={handleGuestLogin}
                                user={user} onResumeRoom={resumeRoom} db={db}
                            />
                        )}
                        {mode === 'teacher' && (
                            <TeacherDashboard 
                                user={user} db={db}
                                roomId={roomId} roomName={currentRoomName} onUpdateRoomName={updateRoomName}
                                participants={participants} messages={messages} onSendMessage={sendMessage}
                                onDeleteMessage={deleteMessage} onForceExit={forceExit}
                                onLowerAllHands={lowerAllHands} onUpdateStatus={updateParticipantStatus}
                                onMarkAsRead={markAsRead}
                            />
                        )}
                        {mode === 'student' && user && (
                            <StudentDashboard 
                                user={user} roomName={currentRoomName}
                                messages={messages} 
                                onSendMessage={(text) => {
                                    const myInfo = participants.find(p => p.id === user.uid);
                                    const name = myInfo ? myInfo.name : (user.displayName || 'ÂêçÁÑ°„Åó');
                                    sendMessage(text, user.uid, name, 'student');
                                }}
                                onDeleteMessage={deleteMessage}
                                onUpdateStatus={updateParticipantStatus} participants={participants}
                                onMarkAsRead={markAsRead}
                            />
                        )}
                    </main>
                </div>
            );
        }

        function LandingView({ roomId, setRoomId, studentName, setStudentName, onCreateRoom, onJoinRoom, onLogin, onLoginGuest, user, onResumeRoom, db }) {
            const [activeTab, setActiveTab] = useState('student');
            const [myRooms, setMyRooms] = useState([]);
            const [newRoomName, setNewRoomName] = useState('');

            useEffect(() => {
                if (activeTab === 'teacher' && user && !user.isAnonymous) {
                    const q = query(collection(db, 'classroom_rooms'), where('teacherId', '==', user.uid));
                    getDocs(q).then(snap => {
                        const rooms = [];
                        snap.forEach(d => rooms.push({ id: d.id, ...d.data() }));
                        rooms.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
                        setMyRooms(rooms);
                    });
                }
            }, [activeTab, user]);

            const deleteRoom = async (rid, e) => {
                e.stopPropagation();
                if(!confirm('Â±•Ê≠¥„Åã„ÇâÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;
                await deleteDoc(doc(db, 'classroom_rooms', rid));
                setMyRooms(prev => prev.filter(r => r.id !== rid));
            };

            const handleStudentJoin = async (method) => {
                if (!roomId) return;
                let targetUser = user;
                if (!targetUser) {
                    if (method === 'google') targetUser = await onLogin();
                    if (method === 'guest') targetUser = await onLoginGuest();
                }
                if (targetUser) onJoinRoom(targetUser);
            };

            return (
                <div className="flex flex-col items-center pt-8 px-4">
                    <div className="w-full max-w-md bg-white rounded-xl shadow-lg overflow-hidden">
                        <div className="flex border-b border-gray-100">
                            <button onClick={()=>setActiveTab('student')} className={`flex-1 py-3 text-sm font-bold flex items-center justify-center gap-2 ${activeTab === 'student' ? 'bg-indigo-50 text-indigo-600 border-b-2 border-indigo-600' : 'text-gray-500'}`}><User className="w-4 h-4"/> ÁîüÂæí</button>
                            <button onClick={()=>setActiveTab('teacher')} className={`flex-1 py-3 text-sm font-bold flex items-center justify-center gap-2 ${activeTab === 'teacher' ? 'bg-indigo-50 text-indigo-600 border-b-2 border-indigo-600' : 'text-gray-500'}`}><School className="w-4 h-4"/> ÊïôÂ∏´</button>
                        </div>
                        <div className="p-6 space-y-4">
                            {activeTab === 'student' ? (
                                <>
                                    <h2 className="text-lg font-bold text-center">ÊéàÊ•≠„Å´ÂèÇÂä†</h2>
                                    <input value={roomId} onChange={e=>setRoomId(e.target.value.toUpperCase())} placeholder="ÈÉ®Â±ãID (‰æã: X7Y2Z9)" className="w-full bg-gray-50 border rounded-lg px-4 py-3 uppercase font-mono" />
                                    <input value={studentName} onChange={e=>setStudentName(e.target.value)} placeholder="Ë°®Á§∫Âêç (Á©∫Ê¨Ñ„Å™„ÇâGoogleÂêç)" className="w-full bg-gray-50 border rounded-lg px-4 py-3" />
                                    <div className="space-y-3 pt-2">
                                        <button onClick={() => handleStudentJoin('google')} disabled={!roomId} className="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 flex items-center justify-center gap-2 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors">{user ? "ÂÖ•ÂÆ§„Åô„Çã" : "Google„Åß„É≠„Ç∞„Ç§„É≥„Åó„Å¶ÂÖ•ÂÆ§"} <ArrowRight className="w-4 h-4"/></button>
                                        {!user && (<div className="text-center"><button onClick={() => handleStudentJoin('guest')} disabled={!roomId} className="text-sm text-gray-500 underline hover:text-indigo-600 disabled:text-gray-300">„É≠„Ç∞„Ç§„É≥„Åõ„Åö„Å´ÂÖ•ÂÆ§</button><p className="text-[10px] text-gray-400 mt-1">‚ÄªÂ±•Ê≠¥„ÅØÂèÇÁÖß„Åß„Åç„Åæ„Åõ„Çì</p></div>)}
                                    </div>
                                </>
                            ) : (
                                <>
                                    <h2 className="text-lg font-bold text-center">ÊéàÊ•≠„ÇíÈñãÂßã</h2>
                                    <input value={newRoomName} onChange={e=>setNewRoomName(e.target.value)} placeholder="„É´„Éº„É†Âêç (‰æã: Êï∞Â≠¶IA)" className="w-full bg-gray-50 border rounded-lg px-4 py-3" />
                                    <button onClick={()=>onCreateRoom(newRoomName)} className="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 flex items-center justify-center gap-2">{user ? "‰ΩúÊàê" : "Google„Åß‰ΩúÊàê"} <ArrowRight className="w-4 h-4"/></button>
                                    {user && myRooms.length > 0 && (
                                        <div className="mt-4 pt-4 border-t border-gray-100">
                                            <p className="text-xs font-bold text-gray-500 mb-2">Â±•Ê≠¥</p>
                                            <div className="max-h-48 overflow-y-auto space-y-2">
                                                {myRooms.map(r => (
                                                    <div key={r.id} onClick={()=>onResumeRoom(r.id)} className="flex justify-between items-center p-2 bg-gray-50 border rounded hover:bg-indigo-50 cursor-pointer group"><div className="truncate flex-1"><div className="font-bold text-sm truncate">{r.name}</div><div className="text-[10px] text-gray-400 font-mono">{r.id}</div></div><button onClick={(e)=>deleteRoom(r.id,e)} className="p-1.5 text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100"><Trash2 className="w-3 h-3"/></button></div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // --- Teacher Dashboard ---
        function TeacherDashboard({ user, db, roomId, roomName, onUpdateRoomName, participants, messages, onSendMessage, onDeleteMessage, onForceExit, onLowerAllHands, onUpdateStatus, onMarkAsRead }) {
            const [isEditing, setIsEditing] = useState(false);
            const [editName, setEditName] = useState('');
            const [sortMode, setSortMode] = useState('join');
            const [copied, setCopied] = useState(false);
            const [broadcastText, setBroadcastText] = useState('');
            // „Ç∞„É™„ÉÉ„ÉâÂàóÊï∞„ÅÆ„Çπ„ÉÜ„Éº„Éà (ÂàùÊúüÂÄ§ 4)
            const [gridCols, setGridCols] = useState(4);

            useEffect(() => { if(isEditing) setEditName(roomName); }, [isEditing, roomName]);

            useEffect(() => {
                const checkOwnership = async () => {
                    if (!user || !roomId) return;
                    try {
                        const roomDoc = await getDoc(doc(db, 'classroom_rooms', roomId));
                        if (roomDoc.exists() && roomDoc.data().teacherId !== user.uid) {
                            alert("Ê®©Èôê„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÈÄÄÂá∫„Åó„Åæ„Åô„ÄÇ");
                            onForceExit();
                        }
                    } catch (error) { console.error("Auth check failed:", error); }
                };
                checkOwnership();
            }, [roomId, user, db]);

            const handleExport = () => {
                const header = "Êó•ÊôÇ,ÈÄÅ‰ø°ËÄÖID,ÈÄÅ‰ø°ËÄÖÂêç,Á®ÆÂà•,„É°„ÉÉ„Çª„Éº„Ç∏\n";
                const rows = messages.map(m => {
                    const time = formatDateFull(m.timestamp);
                    const text = m.text.replace(/"/g, '""'); 
                    return `"${time}","${m.studentId}","${m.studentName}","${m.senderType}","${text}"`;
                }).join("\n");
                const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), header + rows], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `chat_log_${roomId}.csv`;
                link.click();
            };

            const copyLink = () => {
                const url = `${window.location.origin}${window.location.pathname}?room=${roomId}`;
                navigator.clipboard.writeText(url).then(() => { setCopied(true); setTimeout(() => setCopied(false), 2000); }).catch(() => prompt("URL:", url));
            };

            const sendBroadcast = () => {
                if (!broadcastText.trim()) return;
                onSendMessage(broadcastText, 'ALL', 'ÂÖàÁîü(‰∏ÄÊñâ)', 'teacher');
                setBroadcastText('');
            };

            const studentThreads = useMemo(() => {
                const sortedParticipants = [...participants].sort((a, b) => {
                    if (sortMode === 'name') return a.name.localeCompare(b.name, 'ja');
                    return (a.joinedAt?.toMillis() || 0) - (b.joinedAt?.toMillis() || 0);
                });
                
                const broadcasts = messages.filter(m => m.studentId === 'ALL');

                return sortedParticipants.map(p => {
                    const personalMsgs = messages.filter(m => m.studentId === p.id);
                    const allMsgs = [...personalMsgs, ...broadcasts].sort((a, b) => 
                        (a.timestamp?.toMillis() || 0) - (b.timestamp?.toMillis() || 0)
                    );
                    return { participant: p, messages: allMsgs };
                });
            }, [participants, messages, sortMode]);

            return (
                <div className="space-y-4 h-[calc(100vh-80px)] flex flex-col">
                    <div className="bg-white p-3 rounded-xl shadow-sm border flex flex-col gap-3 flex-shrink-0">
                        {/* ‰∏äÊÆµ: ÂêçÂâçÁ∑®ÈõÜ & ÂÖ®Âì°ÈÄÅ‰ø° */}
                        <div className="flex flex-col md:flex-row gap-3 items-center justify-between">
                            <div className="flex items-center gap-2">
                                {isEditing ? (
                                    <div className="flex gap-1">
                                        <input value={editName} onChange={e=>setEditName(e.target.value)} className="border rounded px-2 py-1 text-sm w-32" autoFocus />
                                        <button onClick={()=>{onUpdateRoomName(editName); setIsEditing(false)}} className="bg-green-100 text-green-700 p-1 rounded"><Save className="w-4 h-4"/></button>
                                    </div>
                                ) : (
                                    <div className="flex items-center gap-2 cursor-pointer hover:bg-gray-50 px-2 py-1 rounded" onClick={()=>setIsEditing(true)}>
                                        <h2 className="text-lg font-bold truncate max-w-[150px]">{roomName || 'ÂêçÁß∞Êú™Ë®≠ÂÆö'}</h2>
                                        <Pencil className="w-3 h-3 text-gray-400"/>
                                    </div>
                                )}
                                <span className="text-xs bg-gray-100 px-2 py-1 rounded text-gray-500 font-bold">{participants.length}Âêç</span>
                            </div>

                            <div className="flex items-center gap-2 flex-1 max-w-md w-full">
                                <Megaphone className="w-4 h-4 text-indigo-500" />
                                <input value={broadcastText} onChange={e=>setBroadcastText(e.target.value)} className="flex-1 border rounded px-2 py-1 text-sm" placeholder="ÂÖ®Âì°„Å´ÈÄÅ‰ø°..." />
                                <button onClick={sendBroadcast} className="bg-indigo-600 text-white px-3 py-1 rounded text-sm hover:bg-indigo-700"><Send className="w-3 h-3"/></button>
                            </div>
                        </div>
                        
                        {/* ‰∏ãÊÆµ: „Ç¢„ÇØ„Ç∑„Éß„É≥ & „Çπ„É©„Ç§„ÉÄ„Éº */}
                        <div className="flex flex-wrap items-center justify-between gap-3">
                            {/* ÂàóÊï∞„Çπ„É©„Ç§„ÉÄ„Éº */}
                            <div className="flex items-center gap-2 bg-gray-50 px-3 py-1.5 rounded border border-gray-200">
                                <LayoutGrid className="w-4 h-4 text-gray-500" />
                                <input 
                                    type="range" 
                                    min="1" 
                                    max="6" 
                                    value={gridCols} 
                                    onChange={(e) => setGridCols(Number(e.target.value))}
                                    className="w-24 h-1.5 bg-gray-300 rounded-lg appearance-none cursor-pointer"
                                />
                                <span className="text-xs font-bold text-gray-500 w-3 text-center">{gridCols}</span>
                            </div>

                            <div className="flex gap-2">
                                <button onClick={onLowerAllHands} className="flex items-center gap-1 px-3 py-1.5 bg-red-50 hover:bg-red-100 text-red-600 text-xs rounded font-bold transition" title="ÂÖ®Âì°„ÅÆÊâã„Çí‰∏ã„Åí„Çã">
                                    <Hand className="w-3 h-3"/> ÂÖ®‰∏ã„Åí
                                </button>
                                <button onClick={copyLink} className="hidden sm:flex items-center gap-1 px-3 py-1.5 bg-indigo-50 hover:bg-indigo-100 text-indigo-700 text-xs rounded font-bold transition">
                                    {copied ? <Check className="w-3 h-3"/> : <Copy className="w-3 h-3"/>}
                                </button>
                                <button onClick={()=>setSortMode(s => s === 'join' ? 'name' : 'join')} className="flex items-center gap-1 px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-xs rounded font-bold transition">
                                    <ArrowUpDown className="w-3 h-3"/> {sortMode === 'join' ? 'ÂÖ•ÂÆ§' : 'Ê∞èÂêç'}
                                </button>
                                <button onClick={handleExport} className="hidden sm:flex items-center gap-1 px-3 py-1.5 bg-green-50 hover:bg-green-100 text-green-700 text-xs rounded font-bold transition">
                                    <Download className="w-3 h-3"/>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div className="flex-1 overflow-y-auto pr-1">
                        <div 
                            className="grid gap-3 pb-10"
                            style={{ gridTemplateColumns: `repeat(${gridCols}, minmax(0, 1fr))` }}
                        >
                            {studentThreads.map(({ participant, messages }) => (
                                <CompactChatCard 
                                    key={participant.id} 
                                    participant={participant} 
                                    messages={messages} 
                                    onSendMessage={onSendMessage}
                                    onDeleteMessage={onDeleteMessage}
                                    onUpdateStatus={onUpdateStatus}
                                    onMarkAsRead={onMarkAsRead}
                                />
                            ))}
                        </div>
                    </div>
                </div>
            );
        }

        function CompactChatCard({ participant, messages, onSendMessage, onDeleteMessage, onUpdateStatus, onMarkAsRead }) {
            const [input, setInput] = useState('');
            const scrollRef = useRef(null);

            useEffect(() => { if (scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight; }, [messages]);

            useEffect(() => {
                const unreadMsgs = messages.filter(m => m.senderType === 'student' && !m.read && !m.deleted);
                if (unreadMsgs.length > 0) {
                    unreadMsgs.forEach(m => onMarkAsRead(m.id));
                }
            }, [messages]);

            const lastMsg = messages[messages.length - 1];
            const isUnread = lastMsg && lastMsg.senderType === 'student' && !lastMsg.deleted && !lastMsg.read;
            const isHandRaised = participant.handRaised;

            const sendQuick = (text) => onSendMessage(text, participant.id, participant.name, 'teacher');
            const lowerHand = () => onUpdateStatus(participant.id, { handRaised: false });

            return (
                <div className={`
                    bg-white rounded-lg border shadow-sm flex flex-col h-[320px] overflow-hidden transition-all relative
                    ${isHandRaised ? 'bg-red-50 border-red-300 ring-2 ring-red-200' : ''}
                    ${isUnread ? 'border-orange-400 ring-2 ring-orange-100' : 'border-gray-200'}
                `}>
                    <div className={`px-3 py-2 border-b flex justify-between items-center ${isHandRaised ? 'bg-red-100' : 'bg-gray-50'}`}>
                        <div className="truncate font-bold text-sm flex-1" title={participant.name}>{participant.name}</div>
                        <div className="flex gap-1 items-center">
                            {participant.vote === 'O' && <div className="text-green-600 bg-white rounded-full p-0.5"><Circle className="w-4 h-4"/></div>}
                            {participant.vote === 'X' && <div className="text-red-600 bg-white rounded-full p-0.5"><X className="w-4 h-4"/></div>}
                            {isHandRaised && (
                                <button onClick={lowerHand} className="text-red-500 bg-white rounded-full p-0.5 hover:bg-red-50 animate-bounce" title="Êâã„Çí‰∏ã„Åí„Åï„Åõ„Çã">
                                    <Hand className="w-4 h-4"/>
                                </button>
                            )}
                        </div>
                    </div>

                    <div ref={scrollRef} className="flex-1 overflow-y-auto p-2 space-y-2 bg-white/50 text-xs">
                        {messages.length === 0 && <div className="text-center text-gray-300 mt-4">- No Data -</div>}
                        {messages.map((msg, index) => {
                            const isTeacher = msg.senderType === 'teacher';
                            const isBroadcast = msg.studentId === 'ALL';
                            const prevMsg = messages[index - 1];
                            const showDate = !prevMsg || !isSameDay(prevMsg.timestamp, msg.timestamp);

                            return (
                                <React.Fragment key={msg.id}>
                                    {showDate && <div className="text-center text-[10px] text-gray-400 my-2 opacity-70">- {formatDateShort(msg.timestamp)} -</div>}
                                    <div className={`flex ${isTeacher ? 'justify-end' : 'justify-start'}`}>
                                        <div className={`max-w-[90%] rounded px-2 py-1.5 break-words group relative ${
                                            msg.deleted ? 'bg-gray-100 text-gray-400 italic border' : 
                                            isBroadcast ? 'bg-orange-100 text-orange-800 border border-orange-200' :
                                            isTeacher ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-800'
                                        }`}>
                                            {isBroadcast && <div className="text-[9px] font-bold opacity-70 mb-0.5">‰∏ÄÊñâÈÖç‰ø°</div>}
                                            {msg.text}
                                            <div className="flex items-center justify-end gap-1 mt-0.5">
                                                <span className={`text-[9px] opacity-70 ${isTeacher && !isBroadcast ? 'text-indigo-100' : 'text-gray-400'}`}>{formatTime(msg.timestamp)}</span>
                                                {isTeacher && msg.read && <span className="text-[9px] font-bold opacity-90 text-white">Êó¢Ë™≠</span>}
                                            </div>
                                            {!msg.deleted && isTeacher && (
                                                <button onClick={()=>onDeleteMessage(msg.id)} className="absolute -left-4 top-0 text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100"><Trash2 className="w-3 h-3"/></button>
                                            )}
                                        </div>
                                    </div>
                                </React.Fragment>
                            );
                        })}
                    </div>

                    <div className="p-2 border-t bg-gray-50 space-y-2">
                        <div className="flex justify-between gap-1">
                            <button onClick={()=>sendQuick("ÂÖ∑‰ΩìÁöÑ„Å´Êïô„Åà„Å¶üôá")} className="flex-1 bg-white border border-gray-200 text-[10px] py-1 rounded hover:bg-gray-100">ÂÖ∑‰ΩìÁöÑ„Å´?</button>
                            <button onClick={()=>sendQuick("‰∫ÜËß£„Åó„Åæ„Åó„Åüü´°")} className="flex-1 bg-white border border-gray-200 text-[10px] py-1 rounded hover:bg-gray-100">‰∫ÜËß£ü´°</button>
                            <button onClick={()=>sendQuick("Á¥†Êô¥„Çâ„Åó„ÅÑÔºÅüëç")} className="flex-1 bg-white border border-gray-200 text-[10px] py-1 rounded hover:bg-gray-100">üëç</button>
                        </div>
                        <form onSubmit={(e)=>{e.preventDefault(); if(input.trim()){ onSendMessage(input, participant.id, participant.name, 'teacher'); setInput('');}}} className="flex gap-1">
                            <input value={input} onChange={e=>setInput(e.target.value)} className="flex-1 border rounded px-2 py-1 text-xs" placeholder="ÂÖ•Âäõ..." />
                            <button type="submit" className="bg-indigo-600 text-white px-2 rounded"><Send className="w-3 h-3"/></button>
                        </form>
                    </div>
                </div>
            );
        }

        // --- Student Dashboard ---
        function StudentDashboard({ user, roomName, messages, onSendMessage, onDeleteMessage, onUpdateStatus, participants, onMarkAsRead }) {
            const [input, setInput] = useState('');
            const scrollRef = useRef(null);
            
            const myStatus = participants.find(p => p.id === user.uid) || {};
            // „Éñ„É≠„Éº„Éâ„Ç≠„É£„Çπ„Éà„ÇíÂê´„ÇÅ„Å¶ÂèñÂæó
            const broadcasts = messages.filter(m => m.studentId === 'ALL');
            const personalMsgs = messages.filter(m => m.studentId === user.uid);
            const myMessages = [...personalMsgs, ...broadcasts].sort((a, b) => 
                (a.timestamp?.toMillis() || 0) - (b.timestamp?.toMillis() || 0)
            );

            useEffect(() => { if (scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight; }, [myMessages]);

            // Êó¢Ë™≠Âá¶ÁêÜ: ÂÖàÁîü„Åã„Çâ„ÅÆÊú™Ë™≠„É°„ÉÉ„Çª„Éº„Ç∏„Åå„ÅÇ„Çå„Å∞Êó¢Ë™≠„Å´„Åô„Çã
            useEffect(() => {
                const unreadMsgs = myMessages.filter(m => m.senderType === 'teacher' && !m.read && !m.deleted);
                if (unreadMsgs.length > 0) {
                    unreadMsgs.forEach(m => onMarkAsRead(m.id));
                }
            }, [myMessages]);

            const toggleHand = () => onUpdateStatus(user.uid, { handRaised: !myStatus.handRaised });
            const castVote = (val) => onUpdateStatus(user.uid, { vote: myStatus.vote === val ? null : val });

            return (
                <div className="max-w-xl mx-auto h-[calc(100vh-80px)] bg-white rounded-xl shadow-lg flex flex-col border overflow-hidden">
                    <div className="bg-indigo-50 p-2 flex justify-around items-center border-b border-indigo-100">
                        <button onClick={toggleHand} className={`flex flex-col items-center gap-1 p-2 rounded-lg w-20 transition-all ${myStatus.handRaised ? 'bg-red-500 text-white shadow-md scale-105' : 'bg-white text-gray-600 border'}`}>
                            <Hand className="w-5 h-5"/> <span className="text-[10px] font-bold">ÊåôÊâã</span>
                        </button>
                        <div className="h-8 w-px bg-indigo-200 mx-2"></div>
                        <div className="flex gap-2">
                             <button onClick={()=>castVote('O')} className={`flex flex-col items-center gap-1 p-2 rounded-lg w-16 transition-all ${myStatus.vote === 'O' ? 'bg-green-500 text-white shadow-md' : 'bg-white text-gray-600 border'}`}>
                                <Circle className="w-5 h-5"/> <span className="text-[10px] font-bold">„Åæ„Çã</span>
                            </button>
                            <button onClick={()=>castVote('X')} className={`flex flex-col items-center gap-1 p-2 rounded-lg w-16 transition-all ${myStatus.vote === 'X' ? 'bg-red-500 text-white shadow-md' : 'bg-white text-gray-600 border'}`}>
                                <X className="w-5 h-5"/> <span className="text-[10px] font-bold">„Å∞„Å§</span>
                            </button>
                        </div>
                    </div>

                    <div ref={scrollRef} className="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50">
                        {myMessages.length === 0 && <div className="text-center text-gray-400 text-sm mt-10">Ë≥™Âïè„ÇÑÊÑèË¶ã„ÇíÈÄÅ„Å£„Å¶„Åø„Åæ„Åó„Çá„ÅÜ</div>}
                        {myMessages.map((msg, index) => {
                            const prevMsg = myMessages[index - 1];
                            const showDate = !prevMsg || !isSameDay(prevMsg.timestamp, msg.timestamp);
                            const isBroadcast = msg.studentId === 'ALL';

                            return (
                                <React.Fragment key={msg.id}>
                                    {showDate && <div className="text-center text-xs text-gray-400 my-4 opacity-70">- {formatDateShort(msg.timestamp)} -</div>}
                                    <div className={`flex ${msg.senderType === 'student' ? 'justify-end' : 'justify-start'}`}>
                                        <div className={`max-w-[85%] rounded-xl px-4 py-2 text-sm break-words relative group ${
                                            msg.deleted ? 'bg-gray-200 text-gray-500 italic border' :
                                            isBroadcast ? 'bg-orange-100 text-orange-800 border border-orange-200' :
                                            msg.senderType === 'student' ? 'bg-indigo-600 text-white' : 'bg-white text-gray-800 border'
                                        }`}>
                                            {isBroadcast && <div className="text-[10px] font-bold opacity-70 mb-1 text-orange-600">ÂÖàÁîü„Åã„Çâ„ÅÆ„ÅäÁü•„Çâ„Åõ</div>}
                                            {msg.text}
                                            <div className="flex items-center justify-end gap-1 mt-1">
                                                <span className={`text-[10px] opacity-70 ${msg.senderType === 'student' ? 'text-indigo-100' : 'text-gray-400'}`}>{formatTime(msg.timestamp)}</span>
                                                {msg.senderType === 'student' && msg.read && <span className="text-[10px] font-bold opacity-90 text-white">Êó¢Ë™≠</span>}
                                            </div>
                                            {!msg.deleted && msg.senderType === 'student' && (
                                                <button onClick={()=>onDeleteMessage(msg.id)} className="absolute -left-8 top-1/2 -translate-y-1/2 text-gray-300 hover:text-red-500 p-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                                    <Trash2 className="w-4 h-4"/>
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                </React.Fragment>
                            );
                        })}
                    </div>

                    <div className="p-3 bg-white border-t">
                        <form onSubmit={(e)=>{e.preventDefault(); if(input.trim()){ onSendMessage(input); setInput(''); }}} className="flex gap-2">
                            <input value={input} onChange={e=>setInput(e.target.value)} className="flex-1 border rounded-lg px-3 py-2" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏..." />
                            <button type="submit" className="bg-indigo-600 text-white px-4 rounded-lg"><Send className="w-5 h-5"/></button>
                        </form>
                    </div>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
